<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Rock</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#9AE34A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Task Rock">
    <meta name="application-name" content="Task Rock">
    <meta name="msapplication-TileColor" content="#9AE34A">
    
    <!-- Icons for Browser Tabs and Mobile -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/browser-window-tab-thumbnail.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/browser-window-tab-thumbnail.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/browser-window-tab-thumbnail.png">
    <link rel="mask-icon" href="assets/images/browser-window-tab-thumbnail.png" color="#9AE34A">
    
    <!-- Favicon for older browsers -->
    <link rel="shortcut icon" href="assets/images/browser-window-tab-thumbnail.png">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Task Rock - A fun task management app with Jerry the Rock, your virtual pet companion">
    <meta name="keywords" content="task manager, productivity, pet rock, jerry, tasks, todo">
    <meta name="author" content="Task Rock">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Task Rock - Pet Rock Task Manager">
    <meta property="og:description" content="A fun task management app with Jerry the Rock, your virtual pet companion">
    <meta property="og:image" content="assets/images/icon-512x512.png">
    <meta property="og:url" content="https://storygrid00.github.io/Task_Rock">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Task Rock - Pet Rock Task Manager">
    <meta name="twitter:description" content="A fun task management app with Jerry the Rock, your virtual pet companion">
    <meta name="twitter:image" content="assets/images/icon-512x512.png">
    
    <!-- Firebase SDK v10.12.1 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js';
        import { getMessaging, getToken, deleteToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-messaging.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLGmPRuqGou8cB_A9QDQ-QF7b8QI",
            authDomain: "task-rock.firebaseapp.com",
            projectId: "task-rock",
            storageBucket: "task-rock.firebasestorage.app",
            messagingSenderId: "359134z310",
            appId: "1:359134z310:web:8edf84d7b9334e4c6e83",
            measurementId: "G-W4CTN7PJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        // Initialize Firebase Cloud Messaging
        const messaging = getMessaging(app);
        
        console.log('Task Rock: Firebase v10.12.1 initialized');
        
        // VAPID Key for FCM
        const VAPID_KEY = 'BDG25rX6YAZvxsKIzfbJ0pdKdZfYF0zx4vpyy3BEH8IMjAXN50WpaPSdHPPGxIDntUEc6cpk46na4Fc89HepDts';
        
        // Request notification permission and get FCM token
        const requestNotificationPermission = async () => {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const token = await getToken(messaging, {
                        vapidKey: VAPID_KEY
                    });
                    console.log('FCM Token:', token);
                    // Store token in localStorage for persistence
                    localStorage.setItem('fcm-token', token);
                    return token;
                } else {
                    console.log('Notifications permission not granted');
                    throw new Error('Notification permission denied');
                }
            } catch (error) {
                console.error('Error getting FCM token:', error);
                throw error;
            }
        };
        
        // Enable notifications function
        const enableNotifications = async () => {
            return await requestNotificationPermission();
        };
        
        // Disable notifications function
        const disableNotifications = async () => {
            try {
                // Get the current token first
                const currentToken = localStorage.getItem('fcm-token');
                if (currentToken) {
                    await deleteToken(messaging, currentToken);
                    console.log('FCM token deleted successfully');
                }
                localStorage.removeItem('fcm-token');
                console.log('FCM notifications disabled');
                return true;
            } catch (error) {
                console.error('Error disabling notifications:', error);
                // Still remove from localStorage even if deleteToken fails
                localStorage.removeItem('fcm-token');
                return false;
            }
        };
        
        // Attach functions to window object for global access
        window.enableNotifications = enableNotifications;
        window.disableNotifications = disableNotifications;
        
        // Handle foreground messages
        onMessage(messaging, (payload) => {
            console.log('Foreground message received:', payload);
            
            // Show notification even when app is in foreground
            if (payload.notification) {
                const notificationTitle = 'Task Rock';
                const notificationOptions = {
                    body: 'You have task(s) to complete :)',
                    icon: '/assets/images/jerry.png',
                    badge: '/assets/images/icon-192x192.png',
                    tag: 'task-rock-notification',
                    silent: false
                };
                
                new Notification(notificationTitle, notificationOptions);
            }
        });
        
        // Register Firebase service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker
                .register('/firebase-messaging-sw.js')
                .then((registration) => {
                    console.log('Firebase Service Worker registered:', registration.scope);
                })
                .catch((err) => {
                    console.error('Firebase Service Worker registration failed:', err);
                });
        }
        
        // Make Firebase functions available globally
        window.firebaseMessaging = messaging;
        window.firebaseApp = app;
        window.enableNotifications = enableNotifications;
        window.disableNotifications = disableNotifications;
        window.requestNotificationPermission = requestNotificationPermission;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
        }

        /* Logo */
        .logo-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .app-logo {
            height: 40px;
            width: auto;
        }

        /* Creature */
        .creature-section {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .creature-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }

        .creature {
            position: relative;
            animation: float 3s ease-in-out infinite;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .creature:hover {
            transform: translateY(-10px) scale(1.05);
            transition: all 0.3s ease;
        }

        .creature-image {
            width: 95% !important;
            height: auto !important;
            object-fit: contain !important;
            object-position: center !important;
            transition: all 0.3s ease;
            max-width: 95% !important;
            display: block !important;
            margin: 0 auto !important;
        }

        /* Short animation for task completion gamification */
        .short-animation {
            animation: shortBounce 0.3s ease-out;
        }

        @keyframes shortBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Bounce animation for task creation */
        .bounce-animation {
            animation: taskBounce 0.4s ease-out;
        }

        @keyframes taskBounce {
            0% { transform: translateY(0); }
            25% { transform: translateY(-10px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }

        /* Congrats message overlay */
        .congrats-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 15000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .congrats-overlay.show {
            opacity: 1;
        }

        .congrats-box {
            background: white;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .congrats-overlay.show .congrats-box {
            transform: scale(1);
        }

        .congrats-message {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            white-space: pre-line;
            line-height: 1.4;
        }

        .congrats-points {
            font-size: 16px;
            font-weight: 500;
            color: #2E7D32;
        }

        .creature-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .creature-name:hover {
            color: #007AFF;
        }

        .creature-name-input {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            border: none;
            background: transparent;
            text-align: center;
            outline: none;
            border-bottom: 2px solid #007AFF;
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .health-bar-container {
            margin-bottom: 15px;
            width: 100%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .health-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .health-fill {
            height: 100%;
            background: #8FEB60;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .health-text {
            font-size: 14px;
            color: #666;
        }

        .task-points {
            background: #007AFF;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 400;
            display: inline-block;
        }

        /* Sections */
        .section {
            margin-bottom: 20px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
        }

        .section-arrow {
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .section-arrow:before {
            content: '▼';
        }

        .section-arrow.expanded:before {
            content: '▲';
        }

        .section-content {
            padding: 16px;
            max-height: 1000px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0 16px;
        }

        /* Tasks */
        .tasks-container {
            position: relative;
            display: flex;
            flex-direction: column;
            height: auto;
            max-height: 500px;
        }

        .tasks-scrollable-area {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f9fafb;
            padding-bottom: 10px;
            flex: 1;
        }

        .tasks-scrollable-area::-webkit-scrollbar {
            width: 6px;
        }

        .tasks-scrollable-area::-webkit-scrollbar-track {
            background: #f9fafb;
            border-radius: 3px;
        }

        .tasks-scrollable-area::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .tasks-scrollable-area::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .sticky-create-button {
            position: sticky;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.9) 0%, #ffffff 100%);
            padding: 16px 0 8px 0;
            border-top: 1px solid #e0e0e0;
            margin-top: 8px;
            text-align: center;
            z-index: 5;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            color: #666;
            margin-bottom: 24px;
        }

        .create-task-btn {
            background: #8FEB60;
            color: #000000;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .create-task-btn:hover {
            outline: 2px solid #000000;
            outline-offset: 0px;
        }

        .create-task-btn:active {
            outline: 2px solid #000000;
            outline-offset: 0px;
            transform: scale(0.98);
        }
        .section {
            background: white;
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }


        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .task-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            position: relative;
        }

        .task-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .action-btn:hover {
            background: #f0f0f0;
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 20px;
        }

        .complete-btn {
            background: #000000;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 30px;
        }

        .task-info {
            display: flex;
            gap: 16px;
        }

        .task-dot-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .task-dot-text {
            font-size: 16px;
            font-weight: 400;
            color: #333;
        }

        .task-dot.easy {
            background-color: #FFD700;
        }

        .task-dot.medium {
            background-color: #FFD700;
        }

        .task-dot.hard {
            background-color: #FF6B6B;
        }

        .task-dot.low-priority {
            background-color: #90EE90;
        }

        .task-dot.medium-priority {
            background-color: #FFD700;
        }

        .task-dot.high-priority {
            background-color: #FF0000;
        }

        .task-dot.high {
            background-color: #FF0000;
        }

        .task-dot.medium {
            background-color: #FFD700;
        }

        .task-dot.low {
            background-color: #90EE90;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 400;
        }

        .badge.easy { background: #4CAF50; color: white; }
        .badge.medium { background: #FF9800; color: white; }
        .badge.hard { background: #F44336; color: white; }
        .badge.low { background: #9E9E9E; color: white; }
        .badge.high { background: #E91E63; color: white; }

        .task-due {
            color: #666;
            font-size: 14px;
        }

        .task-due.due-soon {
            color: #ff0000;
            font-weight: bold;
        }

        .complete-btn {
            background: #000000;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            max-width: 120px;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .complete-btn:hover {
            outline: 2px solid #8FEB60;
            outline-offset: 0px;
        }

        .complete-btn:active {
            outline: 2px solid #8FEB60;
            outline-offset: 0px;
            transform: scale(0.98);
        }        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .modal-body {
            padding: 16px 20px;
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f9fafb;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f9fafb;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .selection-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .selection-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s ease;
        }

        .selection-btn.selected {
            border-color: #8FEB60;
            background: #8FEB60;
            color: #000;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: white;
            z-index: 10;
            flex-shrink: 0;
        }

        .btn-primary {
            background: #8FEB60;
            color: #000000;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .btn-primary:hover {
            outline: 2px solid #000000;
            outline-offset: 0px;
        }

        .btn-primary:active {
            outline: 2px solid #000000;
            outline-offset: 0px;
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-secondary:active {
            background: #d1d5db;
            transform: scale(0.98);
        }

        /* Settings */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-header {
            flex: 1;
        }

        .settings-item-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .settings-item-desc {
            font-size: 14px;
            color: #666;
        }

        .share-btn {
            background: #8FEB60;
            color: #000000;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .share-btn:hover {
            outline: 2px solid #000000;
            outline-offset: 0px;
        }

        .share-btn:active {
            outline: 2px solid #000000;
            outline-offset: 0px;
            transform: scale(0.98);
        }

        /* Toggle Switch - iOS Style */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e5ea;
            transition: .3s;
            border-radius: 31px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .toggle-slider {
            background-color: #34c759;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-slider:hover {
            box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.2);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .achievement-item.unlocked {
            background: #f0f9ff;
            border-left-color: #8FEB60;
        }

        .achievement-item.locked {
            opacity: 0.6;
        }

        .achievement-icon {
            font-size: 24px;
            margin-right: 12px;
            min-width: 32px;
        }

        .achievement-content {
            flex: 1;
        }

        .achievement-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .achievement-desc {
            font-size: 12px;
            color: #666;
        }

        .achievement-status {
            font-size: 12px;
            font-weight: 500;
            color: #2E7D32;
        }

        /* Daily Challenge */
        .daily-challenge-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px;
            color: white;
            text-align: center;
        }

        .challenge-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .challenge-desc {
            font-size: 14px;
            margin-bottom: 12px;
            opacity: 0.9;
        }

        .challenge-progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 12px;
        }

        .challenge-progress-text {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: #8FEB60;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .challenge-reward {
            font-size: 14px;
            font-weight: 500;
        }

        .challenge-completed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Shop */
        .shop-category {
            margin-bottom: 24px;
        }

        .shop-category:last-child {
            margin-bottom: 0;
        }

        .shop-category-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (min-width: 400px) {
            .shop-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .shop-grid.scrollable {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding-bottom: 8px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        .shop-grid.scrollable::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        .shop-grid.scrollable .shop-item {
            flex: 0 0 120px;
            min-width: 120px;
        }

        /* Clear Data Section */
        .clear-data-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .clear-data-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
            text-align: center;
        }

        .clear-data-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .clear-data-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-data-btn.partial {
            background-color: #f59e0b;
            color: white;
        }

        .clear-data-btn.partial:hover {
            background-color: #d97706;
        }

        .clear-data-btn.full {
            background-color: #ef4444;
            color: white;
        }

        .clear-data-btn.full:hover {
            background-color: #dc2626;
        }

        /* Reset Modal Styles */
        .reset-options {
            margin: 16px 0;
        }

        .reset-option {
            display: block;
            margin-bottom: 12px;
            font-size: 14px;
            cursor: pointer;
        }

        .reset-option input[type="checkbox"] {
            margin-right: 8px;
        }

        .confirmation-input {
            margin: 16px 0;
        }

        .confirmation-input label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .confirmation-input input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .cancel-btn, .confirm-btn, .danger-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* Email Modal Styles - Modern Task Rock Design */
        #emailModal {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }

        #emailModal .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 480px;
            margin: 5% auto;
            animation: modalSlideIn 0.4s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #emailModal .modal-header {
            background: linear-gradient(135deg, #8FEB60 0%, #7dd956 100%);
            color: #000000;
            padding: 24px 28px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            position: relative;
        }

        #emailModal .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #emailModal .close-btn {
            position: absolute;
            top: 16px;
            right: 20px;
            background: rgba(0, 0, 0, 0.1);
            color: #000000;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #emailModal .close-btn:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(1.1);
        }

        #emailModal .modal-body {
            padding: 20px 24px;
        }

        #emailModal .modal-body p {
            font-size: 15px;
            color: #374151;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 500;
        }

        #emailModal ul {
            margin: 16px 0 20px 0;
            padding: 0;
            list-style: none;
        }

        #emailModal li {
            margin-bottom: 8px;
            font-size: 14px;
            color: #4b5563;
            padding: 6px 0;
            border-left: 3px solid #8FEB60;
            padding-left: 12px;
            background: rgba(143, 235, 96, 0.05);
            border-radius: 0 6px 6px 0;
        }

        .email-input-group {
            display: flex;
            gap: 10px;
            margin: 18px 0;
            flex-direction: column;
        }

        .email-input-group input[type="email"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .email-input-group input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .email-input-group input[type="email"]:focus,
        .email-input-group input[type="text"]:focus {
            outline: none;
            border-color: #8FEB60;
            box-shadow: 0 0 0 3px rgba(143, 235, 96, 0.1);
            transform: translateY(-1px);
        }

        .submit-btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #8FEB60 0%, #7dd956 100%);
            color: #000000;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(143, 235, 96, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #7dd956 0%, #6bc946 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(143, 235, 96, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .privacy-note {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin: 6px 0 12px 0;
            font-style: italic;
        }

        .modal-actions {
            text-align: center;
            margin-top: 12px;
        }

        .skip-btn {
            padding: 12px 24px;
            background: transparent;
            color: #6b7280;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skip-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #4b5563;
            transform: translateY(-1px);
        }
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cancel-btn {
            background-color: #6b7280;
            color: white;
        }

        .cancel-btn:hover {
            background-color: #4b5563;
        }

        .confirm-btn {
            background-color: #3b82f6;
            color: white;
        }

        .confirm-btn:hover {
            background-color: #2563eb;
        }

        .danger-btn {
            background-color: #ef4444;
            color: white;
        }

        .danger-btn:hover {
            background-color: #dc2626;
        }

        .shop-item {
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .shop-item:hover {
            border-color: #8FEB60;
        }

        .shop-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .shop-item.disabled:hover {
            border-color: #e0e0e0;
        }

        .shop-item-icon {
            font-size: 32px;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
        }

        .shop-item-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px;
        }

        .shop-item-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .shop-item-price {
            color: #666;
            font-size: 14px;
        }

        .shop-item-status {
            margin-top: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .shop-item.equipped {
            border-color: #8FEB60;
            background: #f0fdf4;
        }

        .shop-item.equipped .shop-item-status {
            color: #16a34a;
        }

        .shop-item.can-equip .shop-item-status {
            color: #2563eb;
        }

        /* Jerry Dialogue Bubble Styles */
        .jerry-dialogue-bubble {
            position: absolute;
            bottom: 70%;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            padding: 10px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            max-width: 250px;
            text-align: center;
            font-weight: 500;
            color: #333;
            animation: fadeInUp 0.3s ease;
            z-index: 100;
            margin-bottom: 5px;
            border: 2px solid #8FEB60;
        }

        .jerry-dialogue-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #8FEB60;
        }

        .jerry-dialogue-bubble::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #fff;
            z-index: 1;
            margin-top: -2px;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateX(-50%) translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0); 
            }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            .creature-image {
                width: 350px !important;
                height: 210px !important;
                object-fit: contain !important;
                object-position: center !important;
                max-width: 350px !important;
                max-height: 210px !important;
                min-width: 350px !important;
                min-height: 210px !important;
                display: block !important;
                margin: 0 auto !important;
            }
            
            .modal-content {
                margin: 2vh auto;
                width: 95%;
                max-height: 96vh;
            }
            
            .modal-header, .modal-body, .modal-footer {
                padding: 16px;
            }

            .jerry-dialogue-bubble {
                max-width: 200px;
                font-size: 14px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Audio elements for celebration sounds -->
    <audio id="dailyChallengeCompleteSound" preload="auto">
        <source src="assets/sounds/daily_challenge_complete.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>

    <div class="container">
        <!-- Logo Section -->
        <div class="logo-section">
            <img src="assets/images/logo.png" alt="Task Rock" class="app-logo">
        </div>

        <!-- Creature Section -->
        <div class="creature-section">
            <div class="creature-container">
                <div class="creature">
                    <img src="assets/images/jerry.png" alt="Jerry the Rock" class="creature-image" id="creatureImage">
                </div>
            </div>
            <div class="creature-name" onclick="editRockName()" id="rockName">Jerry</div>
            <input type="text" class="creature-name-input" id="rockNameInput" style="display: none;" onblur="saveRockName()" onkeypress="handleRockNameKeypress(event)">
            <div class="health-bar-container">
                <div class="health-bar">
                    <div class="health-fill" id="healthFill"></div>
                </div>
                <div class="health-text" id="healthText">Health 100%</div>
            </div>
            <div class="task-points" id="taskPoints">0 Task Points</div>
        </div>

        <!-- Tasks Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('tasks')">
                <div class="section-title">📝 Your Tasks</div>
                <div class="section-arrow" id="tasksArrow"></div>
            </div>
            <div class="section-content collapsed" id="tasksContent">
                <div class="tasks-container">
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">📝</div>
                        <div class="empty-state-text">No Tasks yet! Create your first task to get started.</div>
                        <button class="create-task-btn" onclick="openModal()">Create Task</button>
                    </div>
                    <div class="tasks-scrollable-area" id="tasksScrollableArea">
                        <div id="tasksList"></div>
                    </div>
                    <div class="sticky-create-button" id="stickyCreateButton" style="display: none;">
                        <button class="create-task-btn" onclick="openModal()">Create Task</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('stats')">
                <div class="section-title">📈 Your Stats</div>
                <div class="section-arrow" id="statsArrow"></div>
            </div>
            <div class="section-content collapsed" id="statsContent">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Tasks</div>
                        <div class="stat-value" id="totalTasks">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Completed Tasks</div>
                        <div class="stat-value" id="completedTasks">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Task Points</div>
                        <div class="stat-value" id="totalPoints">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value" id="completionRate">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">🔥 Current Streak</div>
                        <div class="stat-value" id="currentStreak">0 days</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">🏆 Best Streak</div>
                        <div class="stat-value" id="longestStreak">0 days</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label" id="rockLevelLabel">⭐ Jerry's Level</div>
                        <div class="stat-value" id="jerryLevel">Level 1</div>
                    </div>                    <div class="stat-item">
                        <div class="stat-label">✨ Experience</div>
                        <div class="stat-value" id="jerryXP">0 / 100 XP</div>
                    </div>
                </div>
                
                <!-- Clear Data Section -->
                <div class="clear-data-section">
                    <div class="clear-data-title">🗑️ Reset Options</div>
                    <div class="clear-data-buttons">
                        <button class="clear-data-btn partial" onclick="showPartialResetModal()">Partial Reset</button>
                        <button class="clear-data-btn full" onclick="showFullResetModal()">Clear All Data</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievements Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('achievements')">
                <div class="section-title">🏆 Achievements</div>
                <div class="section-arrow" id="achievementsArrow"></div>
            </div>
            <div class="section-content collapsed" id="achievementsContent">
                <div id="achievementsList" class="achievements-grid">
                    <!-- Achievements will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Daily Challenge Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('dailyChallenge')">
                <div class="section-title">⚡ Daily Challenge</div>
                <div class="section-arrow" id="dailyChallengeArrow"></div>
            </div>
            <div class="section-content collapsed" id="dailyChallengeContent">
                <div id="dailyChallengeDisplay">
                    <!-- Daily challenge will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Shop Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('shop')">
                <div class="section-title">🗿 Rock Shop</div>
                <div class="section-arrow" id="shopArrow"></div>
            </div>
            <div class="section-content collapsed" id="shopContent">
                <div class="shop-category">
                    <h3 class="shop-category-title">Hats</h3>
                    <div class="shop-grid scrollable">
                        <div class="shop-item" onclick="buyItem('blueHat', 50)">
                            <div class="shop-item-icon">🧢</div>
                            <div class="shop-item-name">Blue Cap</div>
                            <div class="shop-item-price">50 Points</div>
                        </div>
                        <div class="shop-item" onclick="buyItem('topHat', 100)">
                            <div class="shop-item-icon">🎩</div>
                            <div class="shop-item-name">Black Top Hat</div>
                            <div class="shop-item-price">100 Points</div>
                        </div>
                        <div class="shop-item" onclick="buyItem('armyHelmet', 200)">
                            <div class="shop-item-icon">🪖</div>
                            <div class="shop-item-name">Army Helmet</div>
                            <div class="shop-item-price">200 Points</div>
                        </div>
                        <div class="shop-item" onclick="buyItem('wizardHat', 400)">
                            <div class="shop-item-icon">
                                <img src="assets/images/wizard-hat-thumbnail.png" alt="Wizard Hat" class="shop-item-image">
                            </div>
                            <div class="shop-item-name">Wizard Hat</div>
                            <div class="shop-item-price">400 Points</div>
                        </div>
                    </div>
                </div>
                
                <div class="shop-category">
                    <h3 class="shop-category-title">Items</h3>
                    <div class="shop-grid">
                        <div class="shop-item" onclick="buyItem('mustache', 350)">
                            <div class="shop-item-icon">
                                <img src="assets/images/mustache-thumbnail.png" alt="Mustache" class="shop-item-image">
                            </div>
                            <div class="shop-item-name">Mustache</div>
                            <div class="shop-item-price">350 Points</div>
                        </div>
                        <div class="shop-item" onclick="buyItem('readingGlasses', 300)">
                            <div class="shop-item-icon">👓</div>
                            <div class="shop-item-name">Reading Glasses</div>
                            <div class="shop-item-price">300 Points</div>
                        </div>
                    </div>
                </div>
                
                <div class="shop-category">
                    <h3 class="shop-category-title">Paint Jobs</h3>
                    <div class="shop-grid">
                        <div class="shop-item" onclick="buyItem('buddyPaint', 800)">
                            <div class="shop-item-icon">
                                <img src="assets/images/buddy-paint-thumbnail.png" alt="Buddy Paint" class="shop-item-image">
                            </div>
                            <div class="shop-item-name">Buddy Paint</div>
                            <div class="shop-item-price">800 Points</div>
                        </div>
                        <div class="shop-item" onclick="buyItem('rockStarPaint', 1000)">
                            <div class="shop-item-icon">
                                <img src="assets/images/jerry-rock-star-paint-thumbnail.png" alt="Rock Star" class="shop-item-image">
                            </div>
                            <div class="shop-item-name">Rock Star</div>
                            <div class="shop-item-price">1000 Points</div>
                        </div>
                        <div class="shop-item" onclick="buyItem('makeupPaint', 1100)">
                            <div class="shop-item-icon">
                                <img src="assets/images/jerry-paint-makeup-thumbnail.png" alt="Makeup" class="shop-item-image">
                            </div>
                            <div class="shop-item-name">Makeup</div>
                            <div class="shop-item-price">1100 Points</div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('settings')">
                <div class="section-title">⚙️ Settings</div>
                <div class="section-arrow" id="settingsArrow"></div>
            </div>
            <div class="section-content collapsed" id="settingsContent">
                <div class="settings-item">
                    <div class="settings-item-header">
                        <div class="settings-item-title">🔔 Task Notifications</div>
                        <div class="settings-item-desc">Get notified when tasks are due soon</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notificationToggle" onchange="toggleNotifications()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <div class="settings-item-header">
                        <div class="settings-item-title">🛍️ Share Rock Shop</div>
                        <div class="settings-item-desc">Help support us by sharing our Etsy store!</div>
                    </div>
                    <button class="share-btn" onclick="shareEtsyStore()">Share Store</button>
                </div>
            </div>  <!-- Create Task Modal -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Task</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" id="taskTitle" placeholder="Enter task title" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Difficulty</label>
                        <div class="selection-group">
                            <button type="button" class="selection-btn" onclick="selectDifficulty('easy', this)">Easy (2 pts)</button>
                            <button type="button" class="selection-btn" onclick="selectDifficulty('medium', this)">Medium (5 pts)</button>
                            <button type="button" class="selection-btn" onclick="selectDifficulty('hard', this)">Hard (7 pts)</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <div class="selection-group">
                            <button type="button" class="selection-btn" onclick="selectPriority('low', this)">Low Priority</button>
                            <button type="button" class="selection-btn" onclick="selectPriority('medium', this)">Medium Priority</button>
                            <button type="button" class="selection-btn" onclick="selectPriority('high', this)">High Priority</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" id="taskDate">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Due Time</label>
                        <input type="time" class="form-input" id="taskTime">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="createTask()">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Partial Reset Modal -->
    <div id="partialResetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Partial Reset</div>
                <button class="close-btn" onclick="closePartialResetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>⚠️ Choose what to reset:</strong></p>
                <div class="reset-options">
                    <label class="reset-option">
                        <input type="checkbox" id="resetTasks"> Clear All Tasks
                    </label>
                    <label class="reset-option">
                        <input type="checkbox" id="resetAchievements"> Reset Achievements
                    </label>
                    <label class="reset-option">
                        <input type="checkbox" id="resetShop"> Clear Shop Items
                    </label>
                    <label class="reset-option">
                        <input type="checkbox" id="resetLevel"> Reset Jerry's Level
                    </label>
                    <label class="reset-option">
                        <input type="checkbox" id="resetStreaks"> Reset Streaks
                    </label>
                </div>
                <div class="modal-actions">
                    <button class="cancel-btn" onclick="closePartialResetModal()">Cancel</button>
                    <button class="confirm-btn" onclick="executePartialReset()">Reset Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Reset Modal -->
    <div id="fullResetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">⚠️ Clear All Data</div>
                <button class="close-btn" onclick="closeFullResetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>This will permanently delete ALL data:</strong></p>
                <ul>
                    <li>All tasks and progress</li>
                    <li>Task points and achievements</li>
                    <li>Jerry's level and experience</li>
                    <li>Shop items and customization</li>
                    <li>Streaks and daily challenges</li>
                </ul>
                <p><strong>This action cannot be undone!</strong></p>
                <div class="confirmation-input">
                    <label>Type "DELETE" to confirm:</label>
                    <input type="text" id="deleteConfirmation" placeholder="Type DELETE">
                </div>
                <div class="modal-actions">
                    <button class="cancel-btn" onclick="closeFullResetModal()">Cancel</button>
                    <button class="danger-btn" onclick="executeFullReset()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Collection Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎉 Exclusive Task Rock Updates!</h2>
                <button class="close-btn" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Get exclusive offers and be the first to know about:</strong></p>
                <ul>
                    <li>✨ New Task Rock features and updates</li>
                    <li>🎁 Special discounts on future products</li>
                    <li>🚀 Early access to new productivity tools</li>
                    <li>💡 Productivity tips and strategies</li>
                </ul>
                <form id="emailForm" class="email-input-group">
                    <input type="text" id="userName" placeholder="Enter your name (optional)" />
                    <input type="email" id="userEmail" placeholder="Enter your email address" required />
                    <button type="submit" class="submit-btn">GET UPDATES</button>
                    <div class="privacy-note">We respect your privacy. Unsubscribe anytime.</div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            health: 100,
            taskPoints: 0,
            tasks: [],
            completedTasks: 0,
            ownedItems: [],
            equippedItems: [],
            rockName: 'Jerry',
            lastTaskCheck: Date.now(),
            isDead: false,
            revivalPoints: 0,
            healthNotificationShown: false,
            healthRecoveryNotificationShown: false,
            // Improved Health System
            lastHealthResetDate: new Date().toDateString(),
            dailyHealthLoss: 0,
            // Streak System
            currentStreak: 0,
            // Email Collection System
            appOpenCount: 0,
            emailSubmitted: false,
            longestStreak: 0,
            lastCompletionDate: null,
            streakMultiplier: 1,
            // Achievement System
            achievements: [],
            unlockedAchievements: [],
            // Level System
            jerryLevel: 1,
            jerryXP: 0,
            jerryXPToNext: 100,
            // Daily Challenges
            dailyChallenge: null,
            dailyChallengeCompleted: false,
            lastDailyChallengeDate: null,
            // Hydration Reminders
            hydrationRemindersEnabled: true,
            lastHydrationReminder: Date.now(),
            hydrationReminderInterval: 60 * 60 * 1000, // 1 hour in milliseconds
            // Task Notifications
            taskNotificationsEnabled: true,
            notifiedTasks: [], // Track which tasks have been notified about
            dueSoonTasks: [] // Track which tasks are marked as due soon (persistent until action taken)
        };

        let selectedDifficulty = null;
        let selectedPriority = null;
        let editingTaskIndex = null;

        // Load game state from localStorage
        function loadGameState() {
            const saved = localStorage.getItem('taskRockGameState');
            if (saved) {
                gameState = { ...gameState, ...JSON.parse(saved) };
            }
        }

        // Save game state to localStorage
        function saveGameState() {
            localStorage.setItem('taskRockGameState', JSON.stringify(gameState));
        }

        // Open modal
        function openModal() {
            document.getElementById('createTaskModal').style.display = 'block';
            resetForm();
        }

        // Close modal
        function closeModal() {
            document.getElementById('createTaskModal').style.display = 'none';
            resetForm();
        }

        // Reset form
        function resetForm() {
            document.getElementById('taskForm').reset();
            document.querySelectorAll('.selection-btn').forEach(btn => btn.classList.remove('selected'));
            selectedDifficulty = null;
            selectedPriority = null;
            editingTaskIndex = null;
            document.querySelector('.modal-title').textContent = 'Create Task';
            document.querySelector('.btn-primary').textContent = 'Create Task';
        }

        // Select difficulty
        function selectDifficulty(difficulty, button) {
            document.querySelectorAll('.selection-btn').forEach(btn => {
                if (btn.parentNode === button.parentNode) {
                    btn.classList.remove('selected');
                }
            });
            button.classList.add('selected');
            selectedDifficulty = difficulty;
        }

        // Select priority
        function selectPriority(priority, button) {
            document.querySelectorAll('.selection-btn').forEach(btn => {
                if (btn.parentNode === button.parentNode) {
                    btn.classList.remove('selected');
                }
            });
            button.classList.add('selected');
            selectedPriority = priority;
        }

        // Create task
        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const date = document.getElementById('taskDate').value;
            const time = document.getElementById('taskTime').value;

            if (!title || !selectedDifficulty || !selectedPriority) {
                alert('Please fill in all required fields');
                return;
            }

            const points = { easy: 2, medium: 5, hard: 7 }[selectedDifficulty];
            
            // Fix date parsing - handle both date formats
            let dueDate = null;
            if (date && time) {
                // Convert MM/DD/YYYY format to YYYY-MM-DD if needed
                let formattedDate = date;
                if (date.includes('/')) {
                    const dateParts = date.split('/');
                    if (dateParts.length === 3) {
                        const month = dateParts[0].padStart(2, '0');
                        const day = dateParts[1].padStart(2, '0');
                        const year = dateParts[2];
                        formattedDate = `${year}-${month}-${day}`;
                    }
                }
                
                // Create the ISO date string
                dueDate = `${formattedDate}T${time}:00`;
                
                // Validate the date
                const testDate = new Date(dueDate);
                if (isNaN(testDate.getTime())) {
                    alert('Please enter a valid date and time');
                    return;
                }
            }

            const task = {
                id: Date.now(),
                title,
                difficulty: selectedDifficulty,
                priority: selectedPriority,
                points,
                dueDate,
                createdAt: Date.now(),
                penaltyApplied: false
            };

            if (editingTaskIndex !== null) {
                const existingTask = gameState.tasks[editingTaskIndex];
                
                // Remove from due soon tracking since task is being edited
                removeDueSoonTracking(existingTask.id);
                
                gameState.tasks[editingTaskIndex] = { ...existingTask, ...task };
                
                // Send push notification for task edit
                sendTaskNotification('edited', task);
            } else {
                gameState.tasks.push(task);
                // Make rock bounce when creating a task
                showBounceAnimation();
                
                // Send push notification for task creation
                sendTaskNotification('created', task);
                
                // Trigger Jerry's response to task creation
                setTimeout(() => {
                    triggerJerryResponse('taskCreate');
                }, 500);
            }

            saveGameState();
            updateUI();
            closeModal();
        }

        // Audio feedback functions
        function playDailyChallengeCompleteSound() {
            try {
                const audio = document.getElementById('dailyChallengeCompleteSound');
                if (audio) {
                    audio.currentTime = 0; // Reset to beginning
                    audio.play().catch(error => {
                        console.log('Task Rock: Audio play failed (user interaction required):', error);
                    });
                }
            } catch (error) {
                console.error('Task Rock: Error playing daily challenge complete sound:', error);
            }
        }

        // Complete task
        function completeTask(index) {
            const task = gameState.tasks[index];
            
            // Clean up notification tracking
            if (task.alertStarted) {
                task.alertStarted = false;
                updateTaskDueTimeColor(task.id, false);
            }
            
            // Remove from due soon tracking since task is being completed
            removeDueSoonTracking(task.id);
            
            // Check for health bonus before removing task
            completeTaskHealthBonus(task);
            
            // Update streak before processing points
            updateStreak();
            
            // Calculate points with streak multiplier
            const basePoints = task.points;
            const multipliedPoints = Math.floor(basePoints * gameState.streakMultiplier);
            
            if (gameState.isDead) {
                // If dead, points go toward revival
                gameState.revivalPoints += multipliedPoints;
                if (gameState.revivalPoints >= 25) {
                    // Revive the rock
                    gameState.isDead = false;
                    gameState.health = 100;
                    gameState.revivalPoints = 0;
                    gameState.taskPoints += (gameState.revivalPoints - 25); // Any extra points go to regular points
                    showCongratsMessage(`🎉 ${gameState.rockName} is revived! Welcome back!`, multipliedPoints);
                } else {
                    showCongratsMessage(`💪 Great progress! ${25 - gameState.revivalPoints} more points to revive ${gameState.rockName}!`, multipliedPoints);
                }
            } else {
                // Normal task completion
                gameState.taskPoints += multipliedPoints;
                gameState.health = Math.min(100, gameState.health + 10);
                
                // Add XP for Jerry's level system
                addJerryXP(basePoints * 2); // XP = points * 2
                
                // Check for achievements
                checkAchievements();
                
                // Update daily challenge progress and check if it was completed
                const dailyChallengeCompleted = updateDailyChallengeProgress();
                
                // Only show regular task completion message if daily challenge wasn't completed
                if (!dailyChallengeCompleted) {
                    const streakBonus = gameState.streakMultiplier > 1 ? ` (${gameState.streakMultiplier}x streak bonus!)` : '';
                    showCongratsMessage(`🎉 Awesome job! Task completed!${streakBonus}`, multipliedPoints);
                }
            }
            
            gameState.completedTasks++;
            gameState.tasks.splice(index, 1);
            
            // Add short animation for gamification
            showShortAnimation();
            
            // Trigger Jerry's response to task completion
            setTimeout(() => {
                triggerJerryResponse('taskComplete');
                
                // Check for streak response
                if (gameState.currentStreak >= 3) {
                    setTimeout(() => {
                        triggerJerryResponse('streak');
                    }, 2000);
                }
            }, 1500);
            
            saveGameState();
            updateUI();
        }

        // Short animation for task completion gamification
        function showShortAnimation() {
            const jerryElement = document.getElementById('creatureImage');
            jerryElement.classList.add('short-animation');
            
            setTimeout(() => {
                jerryElement.classList.remove('short-animation');
            }, 300);
        }

        // Bounce animation for task creation
        function showBounceAnimation() {
            const jerryElement = document.getElementById('creatureImage');
            jerryElement.classList.add('bounce-animation');
            
            setTimeout(() => {
                jerryElement.classList.remove('bounce-animation');
            }, 400);
        }

        // Health notification when below 60%
        function showHealthNotification() {
            // Only show notification if enabled and once per session to avoid spam
            if (!gameState.taskNotificationsEnabled || gameState.healthNotificationShown || gameState.health >= 60) {
                return;
            }
            
            if (gameState.health < 60) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Task Rock Health Warning!', {
                        body: `${gameState.rockName}'s health is at ${gameState.health}%. Complete tasks to restore health!`,
                        icon: 'assets/images/jerry.png'
                    });
                } else if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification('Task Rock Health Warning!', {
                                body: `${gameState.rockName}'s health is at ${gameState.health}%. Complete tasks to restore health!`,
                                icon: 'assets/images/jerry.png'
                            });
                        }
                    });
                }
                gameState.healthNotificationShown = true;
            }
            
            // Reset notification flag when health goes back above 60%
            if (gameState.health >= 60) {
                gameState.healthNotificationShown = false;
            }
        }

        // Show congrats message when completing tasks
        function showCongratsMessage(message, points) {
            // Create congrats overlay
            const overlay = document.createElement('div');
            overlay.className = 'congrats-overlay';
            
            const congratsBox = document.createElement('div');
            congratsBox.className = 'congrats-box';
            
            const messageText = document.createElement('div');
            messageText.className = 'congrats-message';
            messageText.textContent = message;
            
            const pointsText = document.createElement('div');
            pointsText.className = 'congrats-points';
            pointsText.textContent = `+${points} points earned!`;
            
            congratsBox.appendChild(messageText);
            congratsBox.appendChild(pointsText);
            overlay.appendChild(congratsBox);
            document.body.appendChild(overlay);
            
            // Show animation
            setTimeout(() => {
                overlay.classList.add('show');
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                overlay.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 300);
            }, 3000);
        }

        // Edit task
        function editTask(index) {
            const task = gameState.tasks[index];
            editingTaskIndex = index;
            
            document.getElementById('taskTitle').value = task.title;
            
            if (task.dueDate) {
                const date = new Date(task.dueDate);
                document.getElementById('taskDate').value = date.toISOString().split('T')[0];
                document.getElementById('taskTime').value = date.toTimeString().slice(0, 5);
            }

            // Select difficulty and priority
            document.querySelectorAll('.selection-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.toLowerCase().includes(task.difficulty)) {
                    btn.classList.add('selected');
                    selectedDifficulty = task.difficulty;
                }
                if (btn.textContent.toLowerCase().includes(task.priority)) {
                    btn.classList.add('selected');
                    selectedPriority = task.priority;
                }
            });

            document.querySelector('.modal-title').textContent = 'Edit Task';
            document.querySelector('.btn-primary').textContent = 'Update Task';
            document.getElementById('createTaskModal').style.display = 'block';
        }

        // Delete task
        function deleteTask(index) {
            const task = gameState.tasks[index];
            
            // Remove from due soon tracking since task is being deleted
            removeDueSoonTracking(task.id);
            
            gameState.tasks.splice(index, 1);
            saveGameState();
            updateUI();
        }

        // Remove due soon tracking for a specific task
        function removeDueSoonTracking(taskId) {
            if (!gameState.notifiedTasks) {
                return;
            }
            
            // Remove all notification tracking entries for this task
            gameState.notifiedTasks = gameState.notifiedTasks.filter(notificationKey => {
                const keyTaskId = parseInt(notificationKey.split('_')[0]);
                return keyTaskId !== taskId;
            });
            
            // Clear any pending notifications for this task
            if (gameState.pendingNotifications) {
                gameState.pendingNotifications = gameState.pendingNotifications.filter(
                    notification => notification.task.id !== taskId
                );
            }
            
            console.log(`Task Rock: Removed due soon tracking for task ${taskId}`);
        }

        // Toggle menu
        function toggleMenu(index) {
            const menu = document.getElementById(`menu${index}`);
            const isVisible = menu.style.display === 'block';
            
            // Close all menus
            document.querySelectorAll('.menu-dropdown').forEach(m => m.style.display = 'none');
            
            // Toggle current menu
            menu.style.display = isVisible ? 'none' : 'block';
        }

        // Toggle section
        function toggleSection(section) {
            const content = document.getElementById(`${section}Content`);
            const arrow = document.getElementById(`${section}Arrow`);
            content.classList.toggle('collapsed');
            arrow.classList.toggle('expanded');
        }

        // Equip item with exclusivity rules
        function equipItemWithRules(item) {
            // Define item categories
            const hats = ['blueHat', 'topHat', 'armyHelmet', 'wizardHat'];
            const accessories = ['readingGlasses', 'mustache'];
            const paintJobs = ['buddyPaint', 'rockStarPaint', 'makeupPaint'];
            
            // Paint jobs are exclusive - can only be equipped alone
            if (paintJobs.includes(item)) {
                // Remove ALL other items when equipping a paint job
                gameState.equippedItems = [];
                gameState.equippedItems.push(item);
            } else {
                // If trying to equip a non-paint item, remove any paint jobs first
                gameState.equippedItems = gameState.equippedItems.filter(i => !paintJobs.includes(i));
                
                // Handle normal item conflicts
                if (hats.includes(item)) {
                    // Remove other hats
                    gameState.equippedItems = gameState.equippedItems.filter(i => !hats.includes(i));
                }
                
                // Add the new item
                gameState.equippedItems.push(item);
            }
            
            // Trigger item-specific dialogue
            triggerItemEquippedDialogue(item);
        }

        // Get the correct equipment image based on equipped items
        function getEquipmentImage() {
            const equipped = gameState.equippedItems;
            
            // Helper function to check if items are equipped
            const has = (item) => equipped.includes(item);
            
            // Paint jobs are exclusive - check first and return immediately
            if (has('buddyPaint')) {
                return 'assets/images/jerry-buddy-paint.png';
            }
            if (has('rockStarPaint')) {
                return 'assets/images/jerry-rock-star-paint.png';
            }
            if (has('makeupPaint')) {
                return 'assets/images/jerry-paint-makeup.png';
            }
            
            // Define all possible combinations based on the provided image files
            // Priority: Most specific combinations first, then less specific
            
            // 4-ITEM COMBINATIONS (Hat + Both Accessories + Paint)
            
            // 3-ITEM COMBINATIONS
            // Hat + Both Accessories
            if (has('blueHat') && has('readingGlasses') && has('mustache')) {
                return 'assets/images/jerry-glasses-blue-hat-mustache.png';
            }
            if (has('topHat') && has('readingGlasses') && has('mustache')) {
                return 'assets/images/jerry-top-hat-glasses-mustache.png';
            }
            if (has('armyHelmet') && has('readingGlasses') && has('mustache')) {
                return 'assets/images/jerry-army-helmet-mustache-glasses.png';
            }
            if (has('wizardHat') && has('readingGlasses') && has('mustache')) {
                return 'assets/images/jerry-wizard-hat-glasses-mustache.png';
            }
            
            // 2-ITEM COMBINATIONS
            // Hat + Single Accessory
            if (has('blueHat') && has('readingGlasses')) {
                return 'assets/images/jerry-glasses-blue-hat.png';
            }
            if (has('blueHat') && has('mustache')) {
                return 'assets/images/jerry-blue-hat-mustache.png';
            }
            if (has('topHat') && has('readingGlasses')) {
                return 'assets/images/jerry-top-hat-glasses.png';
            }
            if (has('topHat') && has('mustache')) {
                return 'assets/images/jerry-top-hat-mustache.png';
            }
            if (has('armyHelmet') && has('readingGlasses')) {
                return 'assets/images/jerry-army-helmet-glasses.png';
            }
            if (has('armyHelmet') && has('mustache')) {
                return 'assets/images/jerry-mustache-army-helmet.png';
            }
            if (has('wizardHat') && has('readingGlasses')) {
                return 'assets/images/jerry-glasses-wizard-hat.png';
            }
            if (has('wizardHat') && has('mustache')) {
                return 'assets/images/jerry-mustache-wizard-hat.png';
            }
            
            // Both Accessories
            if (has('readingGlasses') && has('mustache')) {
                return 'assets/images/jerry-glasses-mustache.png';
            }
            
            // Individual Accessories
            if (has('readingGlasses')) {
                return 'assets/images/jerry-glasses.png';
            }
            if (has('mustache')) {
                return 'assets/images/jerry-mustache.png';
            }
            
            // Individual Hats
            if (has('wizardHat')) {
                return 'assets/images/jerry-wizard-hat.png';
            }
            if (has('topHat')) {
                return 'assets/images/jerry-top-hat.png';
            }
            if (has('blueHat')) {
                return 'assets/images/jerry-blue-hat.png';
            }
            if (has('armyHelmet')) {
                return 'assets/images/jerry-army-helmet.png';
            }
            
            // DEFAULT JERRY (no equipment)
            return 'assets/images/jerry.png';
        }

        // Buy item with improved touch responsiveness
        function buyItem(item, price) {
            // Prevent multiple rapid clicks
            if (window.buyItemCooldown) return;
            window.buyItemCooldown = true;
            setTimeout(() => window.buyItemCooldown = false, 300);
            
            if (gameState.ownedItems.includes(item)) {
                // Item is owned, toggle equip/unequip
                if (gameState.equippedItems.includes(item)) {
                    // Unequip item
                    gameState.equippedItems = gameState.equippedItems.filter(i => i !== item);
                } else {
                    // Equip item with exclusivity rules
                    equipItemWithRules(item);
                    
                    // Trigger item-specific dialogue for equipping
                    setTimeout(() => {
                        triggerItemEquippedDialogue(item);
                    }, 300);
                }
                saveGameState();
                updateUI();
            } else if (gameState.taskPoints >= price) {
                // Buy and equip new item
                gameState.taskPoints -= price;
                gameState.ownedItems.push(item);
                
                // Equip item with exclusivity rules
                equipItemWithRules(item);
                
                // Trigger item-specific dialogue for buying and equipping
                setTimeout(() => {
                    triggerItemEquippedDialogue(item);
                }, 300);
                
                saveGameState();
                updateUI();
            } else {
                // Do nothing if insufficient funds - item should be disabled
                return;
            }
        }

        // Share Etsy store function
        function shareEtsyStore() {
            const etsyUrl = 'https://www.etsy.com/shop/TaskRock?ref=profile_header&dd_referrer=https%3A%2F%2Fwww.etsy.com%2Fpeople%2Fgwk8ree78qr8npiy%3Fref%3Dhdr_user_menu-profile';
            
            if (navigator.share) {
                // Use native share API if available (mobile devices)
                navigator.share({
                    title: 'Task Rock - Rock Shop',
                    text: 'Check out the amazing Task Rock store on Etsy!',
                    url: etsyUrl
                }).then(() => {
                    showJerryDialog('Thanks for sharing our store! You rock! 🛍️');
                }).catch((error) => {
                    console.log('Error sharing:', error);
                    fallbackShare(etsyUrl);
                });
            } else {
                // Fallback for desktop browsers
                fallbackShare(etsyUrl);
            }
        }

        // Fallback share function for desktop
        function fallbackShare(url) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Store link copied to clipboard! Share it with your friends!');
                    showJerryDialog('Store link copied! Thanks for helping spread the word! 🛍️');
                }).catch(() => {
                    // If clipboard fails, open in new tab
                    window.open(url, '_blank');
                    showJerryDialog('Thanks for visiting our store! 🛍️');
                });
            } else {
                // If no clipboard support, open in new tab
                window.open(url, '_blank');
                showJerryDialog('Thanks for visiting our store! 🛍️');
            }
        }

        // Toggle notifications function
        function toggleNotifications() {
            const toggle = document.getElementById('notificationToggle');
            const newState = toggle.checked;
            
            console.log('Task Rock: Toggle clicked, new state:', newState);
            
            if (newState) {
                // Enable Firebase notifications using exact user logic
                console.log('Task Rock: Enabling Firebase notifications...');
                if (window.enableNotifications) {
                    window.enableNotifications()
                        .then(token => {
                            console.log('Task Rock: FCM Token obtained:', token);
                            gameState.taskNotificationsEnabled = true;
                            gameState.fcmToken = token;
                            saveGameState();
                            
                            showJerryDialog('🔔 Firebase push notifications are now ON! I\'ll send you notifications when tasks are due soon!');
                            startDueTaskChecker();
                            
                            // Ensure toggle stays checked
                            toggle.checked = true;
                        })
                        .catch(error => {
                            console.error('Task Rock: Failed to enable Firebase notifications:', error);
                            showJerryDialog('🔕 Failed to enable notifications. Please allow notifications in your browser settings.');
                            
                            // Reset toggle and state
                            gameState.taskNotificationsEnabled = false;
                            toggle.checked = false;
                            saveGameState();
                        });
                } else {
                    console.error('Task Rock: Firebase enableNotifications function not available');
                    showJerryDialog('🔕 Firebase not loaded. Please refresh the page.');
                    toggle.checked = false;
                }
            } else {
                // Disable Firebase notifications
                console.log('Task Rock: Disabling Firebase notifications...');
                if (window.disableNotifications) {
                    window.disableNotifications()
                        .then(() => {
                            console.log('Task Rock: FCM notifications disabled successfully');
                            gameState.taskNotificationsEnabled = false;
                            delete gameState.fcmToken;
                            saveGameState();
                            
                            showJerryDialog('🔕 Firebase push notifications are now OFF. You can turn them back on anytime!');
                            
                            // Ensure toggle stays unchecked
                            toggle.checked = false;
                        })
                        .catch(error => {
                            console.error('Task Rock: Failed to disable Firebase notifications:', error);
                            gameState.taskNotificationsEnabled = false;
                            delete gameState.fcmToken;
                            saveGameState();
                            
                            showJerryDialog('🔕 Firebase push notifications are now OFF.');
                            toggle.checked = false;
                        });
                } else {
                    console.error('Task Rock: Firebase disableNotifications function not available');
                    gameState.taskNotificationsEnabled = false;
                    toggle.checked = false;
                    saveGameState();
                    showJerryDialog('🔕 Firebase push notifications are now OFF.');
                }
            }
        }

        // Aggressive notification system for iOS locked/sleeping devices
        function sendTaskNotification(eventType, task) {
            console.log(`Task Rock: Notification request for "${task.title}" (${eventType})`);
            
            if (!gameState.taskNotificationsEnabled) {
                console.log('Task Rock: Notifications disabled, skipping');
                return;
            }
            
            // Only send notifications for due-soon events, not for created/edited
            if (eventType !== 'due_soon') {
                console.log(`Task Rock: Skipping notification for "${eventType}" - only due-soon notifications are sent`);
                return;
            }
            
            console.log(`Task Rock: Sending due-soon notification for "${task.title}"`);
            
            const title = `Task Rock`;
            const message = `You have task(s) to complete :)`;
            
            // Send single notification for this specific due time
            sendSingleNotification(title, message, task, `due-soon`);
            
            console.log(`Task Rock: Due-soon notification sent for "${task.title}"`);
        }       
        // Send a single notification with enhanced options for iOS
        function sendSingleNotification(title, message, task, suffix = '') {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notificationOptions = {
                    body: message,
                    icon: '/assets/images/jerry.png',
                    badge: '/assets/images/icon-192x192.png',
                    tag: `task-rock-${task.id}${suffix ? '-' + suffix : ''}`,
                    silent: false
                };
                
                try {
                    const notification = new Notification(title, notificationOptions);
                    
                    // Simple notification click handling
                    notification.onclick = function(event) {
                        event.preventDefault();
                        window.focus();
                        notification.close();
                    };
                    
                    console.log('Task Rock: Text notification sent successfully');
                } catch (error) {
                    console.error('Task Rock: Failed to send notification:', error);
                }
            }
        }
        
        // Background sync notification for iOS background processing
        function scheduleBackgroundNotification(title, message, task) {
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then(registration => {
                    // Store notification data for background sync
                    const notificationData = {
                        title: title,
                        message: message,
                        task: task,
                        timestamp: Date.now(),
                        attempts: 0
                    };
                    
                    // Store in IndexedDB for background sync
                    storeNotificationForBackgroundSync(notificationData);
                    
                    // Register background sync
                    return registration.sync.register(`task-notification-${task.id}-${Date.now()}`);
                }).then(() => {
                    console.log('Task Rock: Background sync notification scheduled');
                }).catch(error => {
                    console.error('Task Rock: Background sync failed:', error);
                });
            }
        }
        
        // Foreground notification fallback system
        function scheduleForegroundFallback(title, message, task) {
            // Check if app becomes active and show missed notifications
            const fallbackKey = `fallback-${task.id}-${Date.now()}`;
            
            // Store fallback notification
            if (!gameState.pendingNotifications) {
                gameState.pendingNotifications = [];
            }
            
            gameState.pendingNotifications.push({
                key: fallbackKey,
                title: title,
                message: message,
                task: task,
                timestamp: Date.now(),
                shown: false
            });
            
            saveGameState();
            
            // Schedule fallback check
            setTimeout(() => {
                checkAndShowForegroundFallbacks();
            }, 300000); // 5 minutes
        }
        
        // Check and show foreground fallback notifications
        function checkAndShowForegroundFallbacks() {
            if (!gameState.pendingNotifications) return;
            
            const now = Date.now();
            const fiveMinutesAgo = now - 300000;
            
            gameState.pendingNotifications.forEach(notification => {
                if (!notification.shown && notification.timestamp > fiveMinutesAgo) {
                    // Show as in-app notification if main notification might have been missed
                    showInAppNotification(notification.title, notification.message);
                    notification.shown = true;
                }
            });
            
            // Clean up old notifications
            gameState.pendingNotifications = gameState.pendingNotifications.filter(
                notification => notification.timestamp > fiveMinutesAgo
            );
            
            saveGameState();
        }
        
        // In-app notification system for fallback
        function showInAppNotification(title, message) {
            // Create in-app notification element
            const notificationElement = document.createElement('div');
            notificationElement.className = 'in-app-notification';
            notificationElement.innerHTML = `
                <div class="notification-content">
                    <strong>${title}</strong>
                    <p>${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Add styles if not already present
            if (!document.querySelector('#in-app-notification-styles')) {
                const styles = document.createElement('style');
                styles.id = 'in-app-notification-styles';
                styles.textContent = `
                    .in-app-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #34c759;
                        color: white;
                        padding: 15px;
                        border-radius: 10px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 10000;
                        max-width: 300px;
                        animation: slideIn 0.3s ease-out;
                    }
                    
                    .notification-content {
                        position: relative;
                    }
                    
                    .notification-content button {
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        background: rgba(255,255,255,0.3);
                        border: none;
                        color: white;
                        width: 25px;
                        height: 25px;
                        border-radius: 50%;
                        cursor: pointer;
                    }
                    
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(notificationElement);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notificationElement.parentElement) {
                    notificationElement.remove();
                }
            }, 10000);
            
            console.log('Task Rock: In-app fallback notification shown');
        }
        
        // Store notification data for background sync
        function storeNotificationForBackgroundSync(notificationData) {
            // Use localStorage as fallback for IndexedDB
            try {
                const existingData = JSON.parse(localStorage.getItem('task-rock-pending-notifications') || '[]');
                existingData.push(notificationData);
                
                // Keep only last 10 notifications to prevent storage bloat
                const recentData = existingData.slice(-10);
                localStorage.setItem('task-rock-pending-notifications', JSON.stringify(recentData));
                
                console.log('Task Rock: Notification stored for background sync');
            } catch (error) {
                console.error('Task Rock: Failed to store notification for background sync:', error);
            }
        }
        
        // Enhanced due task checking with aggressive scheduling
        function startDueTaskChecker() {
            console.log('Task Rock: Starting aggressive due task checker for iOS reliability');
            
            // Clear any existing intervals
            if (window.taskRockDueTaskInterval) {
                clearInterval(window.taskRockDueTaskInterval);
            }
            
            // Primary check every 2 minutes (aggressive for iOS)
            window.taskRockDueTaskInterval = setInterval(() => {
                checkDueTasksAndNotify();
                checkAndShowForegroundFallbacks();
            }, 120000); // 2 minutes
            
            // Secondary check every 5 minutes (redundancy)
            setInterval(() => {
                console.log('Task Rock: Secondary due task check');
                checkDueTasksAndNotify();
            }, 300000); // 5 minutes
            
            // Immediate check
            checkDueTasksAndNotify();
            
            console.log('Task Rock: Aggressive notification system active');
        }

        // Check for due tasks and send notifications
        function checkDueTasksAndNotify() {
            console.log('Task Rock: Checking for due tasks...', {
                totalTasks: gameState.tasks.length,
                currentTime: new Date().toLocaleString()
            });
            
            const now = new Date().getTime();
            
            gameState.tasks.forEach(task => {
                if (!task.dueDate) return;
                
                const dueTime = new Date(task.dueDate).getTime();
                const timeDiff = dueTime - now;
                const minutesUntilDue = Math.round(timeDiff / (1000 * 60));
                
                console.log(`Task Rock: Task "${task.title}" - Due in ${minutesUntilDue} minutes`);
                
                // Check if task is within 20 minutes of due time
                if (minutesUntilDue <= 20 && minutesUntilDue > 0) {
                    // Mark task as due soon and turn due time red
                    if (!task.alertStarted) {
                        task.alertStarted = true;
                        console.log(`Task Rock: Marking task "${task.title}" as due soon`);
                        
                        // Update UI to show red due time
                        updateTaskDueTimeColor(task.id, true);
                        
                        // Send initial notification at 20 minutes
                        sendTaskNotification('due_soon', task);
                        
                        saveGameState();
                    }
                    
                    // Send notifications at specific intervals (20, 15, 10, 5, 2 minutes)
                    if ([20, 15, 10, 5, 2].includes(minutesUntilDue)) {
                        const notificationKey = `${task.id}_${minutesUntilDue}min`;
                        
                        // Check if we already sent this specific notification
                        if (!gameState.notifiedTasks) {
                            gameState.notifiedTasks = [];
                        }
                        
                        if (!gameState.notifiedTasks.includes(notificationKey)) {
                            console.log(`Task Rock: Sending ${minutesUntilDue}-minute notification for "${task.title}"`);
                            sendTaskNotification('due_soon', task);
                            gameState.notifiedTasks.push(notificationKey);
                            saveGameState();
                        }
                    }
                } else if (minutesUntilDue <= 0 && task.alertStarted) {
                    // Task is now overdue, reset alert status
                    task.alertStarted = false;
                    updateTaskDueTimeColor(task.id, false);
                    saveGameState();
                }
            });
            
            // Clean up old notification tracking for completed tasks
            if (gameState.notifiedTasks) {
                const currentTaskIds = gameState.tasks.map(task => task.id);
                gameState.notifiedTasks = gameState.notifiedTasks.filter(notificationKey => {
                    const taskId = parseInt(notificationKey.split('_')[0]);
                    return currentTaskIds.includes(taskId);
                });
            }
        }
        
        // Update task due time color in DOM
        function updateTaskDueTimeColor(taskId, isDueSoon) {
            const taskElements = document.querySelectorAll(`[data-task-id="${taskId}"]`);
            taskElements.forEach(element => {
                const dueTimeElement = element.querySelector('.due-time');
                if (dueTimeElement) {
                    if (isDueSoon) {
                        dueTimeElement.style.color = 'red';
                        dueTimeElement.style.fontWeight = 'bold';
                    } else {
                        dueTimeElement.style.color = '';
                        dueTimeElement.style.fontWeight = '';
                    }
                }
            });
        }

        // Initialize Firebase Cloud Messaging notification system
        function initializeNotificationSystem() {
            console.log('Task Rock: Initializing Firebase Cloud Messaging...');
            
            // Start the task checker
            startDueTaskChecker();
            
            // Request notification permission
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then((permission) => {
                        console.log('Task Rock: Notification permission:', permission);
                        if (permission === 'granted') {
                            initializeFCM();
                        }
                    });
                } else if (Notification.permission === 'granted') {
                    console.log('Task Rock: Notification permission already granted');
                    initializeFCM();
                } else {
                    console.log('Task Rock: Notification permission denied');
                }
            }
        }
        
        // Initialize Firebase Cloud Messaging
        async function initializeFCM() {
            try {
                // Wait for Firebase to be available
                if (!window.firebaseMessaging || !window.firebaseGetToken || !window.firebaseOnMessage) {
                    console.log('Task Rock: Waiting for Firebase to initialize...');
                    setTimeout(initializeFCM, 100);
                    return;
                }
                
                // Register service worker
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
                        type: 'module'
                    });
                    console.log('Task Rock: Firebase service worker registered:', registration);
                    
                    // Get FCM token using globally available function
                    try {
                        const currentToken = await window.firebaseGetToken(window.firebaseMessaging, { 
                            vapidKey: VAPID_KEY,
                            serviceWorkerRegistration: registration 
                        });
                        
                        if (currentToken) {
                            console.log('Task Rock: FCM token:', currentToken);
                            // Store token for sending notifications from server
                            localStorage.setItem('fcm-token', currentToken);
                        } else {
                            console.log('Task Rock: No FCM token available');
                        }
                    } catch (err) {
                        console.log('Task Rock: Error getting FCM token:', err);
                    }
                    
                    // Handle foreground messages using globally available function
                    window.firebaseOnMessage(window.firebaseMessaging, (payload) => {
                        console.log('Task Rock: Foreground message received:', payload);
                        
                        // Show notification even when app is in foreground
                        if (Notification.permission === 'granted') {
                            new Notification(payload.notification?.title || 'Task Rock', {
                                body: payload.notification?.body || 'You have a task reminder!',
                                icon: '/assets/images/jerry.png',
                                badge: '/assets/images/icon-192x192.png'
                            });
                        }
                    });
                }
                
            } catch (error) {
                console.log('Task Rock: Error initializing FCM:', error);
            }
        }

        // Check if task is due within 20 minutes (for visual styling)
        function isTaskDueSoon(task) {
            if (!task.dueDate) return false;
            
            const now = new Date().getTime();
            const dueTime = new Date(task.dueDate).getTime();
            const timeDiff = dueTime - now;
            const minutesUntilDue = Math.round(timeDiff / (1000 * 60));
            
            // Return true if due within 20 minutes
            return minutesUntilDue <= 20 && minutesUntilDue > 0;
        }

        // Start periodic checking for due tasks (every 60 seconds)
        function startDueTaskChecker() {
            // Check every 60 seconds for due tasks
            setInterval(checkDueTasksAndNotify, 60000);
            
            // Also check immediately
            checkDueTasksAndNotify();
        }

        // Update UI
        function updateUI() {
            // Check if rock should die
            if (gameState.health <= 0 && !gameState.isDead) {
                gameState.isDead = true;
                gameState.health = 0;
            }
            
            // Update health
            const healthFill = document.getElementById('healthFill');
            const healthText = document.getElementById('healthText');
            healthFill.style.width = `${gameState.health}%`;
            
            if (gameState.isDead) {
                healthText.textContent = `Revival Progress: ${gameState.revivalPoints}/25 points`;
            } else {
                healthText.textContent = `Health ${gameState.health}%`;
                
                // Health notifications when below 60%
                if (gameState.health < 60 && gameState.health > 0) {
                    showHealthNotification();
                }
            }

            // Update task points
            document.getElementById('taskPoints').textContent = `${gameState.taskPoints} Task Points`;

            // Update rock name
            document.getElementById('rockName').textContent = gameState.rockName;

            // Update creature image based on death state and equipped items
            const creatureImage = document.getElementById('creatureImage');
            if (gameState.isDead) {
                creatureImage.src = 'assets/images/dead-rock.png';
            } else {
                // Get the correct image based on equipped items combination
                const imagePath = getEquipmentImage();
                creatureImage.src = imagePath;
            }

            // Update tasks
            const tasksList = document.getElementById('tasksList');
            const emptyState = document.getElementById('emptyState');
            const stickyCreateButton = document.getElementById('stickyCreateButton');
            const tasksScrollableArea = document.getElementById('tasksScrollableArea');

            if (gameState.tasks.length === 0) {
                emptyState.style.display = 'block';
                tasksScrollableArea.style.display = 'none';
                stickyCreateButton.style.display = 'none';
                tasksList.innerHTML = '';
            } else {
                emptyState.style.display = 'none';
                tasksScrollableArea.style.display = 'block';
                stickyCreateButton.style.display = 'block';
                tasksList.innerHTML = gameState.tasks.map((task, index) => {
                    const isDueSoon = isTaskDueSoon(task);
                    const dueSoonStyle = isDueSoon ? 'color: red; font-weight: bold;' : '';
                    return `
                    <div class="task-item" data-task-id="${task.id}">
                        <div class="task-header">
                            <div class="task-title">${task.title}</div>
                            <div class="task-actions">
                                <button class="action-btn" onclick="editTask(${index})" title="Edit">✏️</button>
                                <button class="action-btn" onclick="deleteTask(${index})" title="Delete">🗑️</button>
                            </div>
                        </div>
                        <div class="task-footer">
                            <div class="task-info">
                                <div class="task-dot-item">
                                    <span class="task-dot ${task.difficulty.toLowerCase()}"></span>
                                    <span class="task-dot-text">${task.difficulty}</span>
                                </div>
                                <div class="task-dot-item">
                                    <span class="task-dot ${task.priority.toLowerCase().replace(' ', '-')}"></span>
                                    <span class="task-dot-text">${task.priority}</span>
                                </div>
                            </div>
                            <button class="complete-btn" onclick="completeTask(${index})">Complete</button>
                        </div>
                        ${task.dueDate ? `<div class="due-time" style="${dueSoonStyle}">Due: ${new Date(task.dueDate).toLocaleDateString()} at ${new Date(task.dueDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>` : ''}
                    </div>
                `;
                }).join('');
            }

            // Update stats
            document.getElementById('totalTasks').textContent = gameState.tasks.length + gameState.completedTasks;
            document.getElementById('completedTasks').textContent = gameState.completedTasks;
            document.getElementById('totalPoints').textContent = gameState.taskPoints;
            const completionRate = gameState.tasks.length + gameState.completedTasks > 0 
                ? Math.round((gameState.completedTasks / (gameState.tasks.length + gameState.completedTasks)) * 100)
                : 100;
            document.getElementById('completionRate').textContent = `${completionRate}%`;
            
            // Update gamification stats
            document.getElementById('currentStreak').textContent = `${gameState.currentStreak} day${gameState.currentStreak !== 1 ? 's' : ''}`;
            document.getElementById('longestStreak').textContent = `${gameState.longestStreak} day${gameState.longestStreak !== 1 ? 's' : ''}`;
            document.getElementById('rockLevelLabel').textContent = `⭐ ${gameState.rockName}'s Level`;
            document.getElementById('jerryLevel').textContent = `Level ${gameState.jerryLevel}`;
            document.getElementById('jerryXP').textContent = `${gameState.jerryXP} / ${gameState.jerryXPToNext} XP`;
            
            // Update achievements display
            updateAchievementsDisplay();
            
            // Update daily challenge display
            updateDailyChallengeDisplay();

            // Update shop items
            document.querySelectorAll('.shop-item').forEach(item => {
                const itemType = item.onclick.toString().match(/buyItem\('(\w+)'/)?.[1];
                const itemPrice = parseInt(item.onclick.toString().match(/buyItem\('\w+',\s*(\d+)\)/)?.[1]);
                
                // Reset classes first
                item.classList.remove('disabled', 'equipped', 'can-equip');
                
                // Remove existing status if any
                const existingStatus = item.querySelector('.shop-item-status');
                if (existingStatus) {
                    existingStatus.remove();
                }
                
                // Add status indicator
                const statusDiv = document.createElement('div');
                statusDiv.className = 'shop-item-status';
                
                if (itemType && gameState.ownedItems.includes(itemType)) {
                    if (gameState.equippedItems.includes(itemType)) {
                        item.classList.add('equipped');
                        statusDiv.textContent = '✓ Equipped';
                    } else {
                        item.classList.add('can-equip');
                        statusDiv.textContent = 'Tap to Equip';
                    }
                    item.querySelector('.shop-item-price').textContent = 'Owned';
                } else if (itemPrice && gameState.taskPoints < itemPrice) {
                    item.classList.add('disabled');
                    statusDiv.textContent = '';
                    item.querySelector('.shop-item-price').textContent = `${itemPrice} Points`;
                } else {
                    statusDiv.textContent = 'Tap to Buy';
                    item.querySelector('.shop-item-price').textContent = `${itemPrice} Points`;
                }
                
                item.appendChild(statusDiv);
            });

            // Update settings toggle state
            const notificationToggle = document.getElementById('notificationToggle');
            if (notificationToggle) {
                notificationToggle.checked = gameState.taskNotificationsEnabled;
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.task-menu')) {
                document.querySelectorAll('.menu-dropdown').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('createTaskModal');
            if (e.target === modal) {
                closeModal();
            }
        });

        // Improved Health penalty system
        function checkHealthPenalties() {
            const now = Date.now();
            let healthLossToday = 0;
            const maxDailyLoss = 50; // Maximum 50% health loss per day
            const minHealth = 10; // Never go below 10% health
            
            // Calculate streak protection (10-30% penalty reduction)
            const streakProtection = Math.min(30, gameState.currentStreak * 2) / 100;
            
            gameState.tasks.forEach(task => {
                if (task.dueDate && !task.completed) {
                    const dueDate = new Date(task.dueDate).getTime();
                    const priority = task.priority || 'medium';
                    
                    // Define grace periods and penalties by priority
                    const priorityConfig = {
                        high: { 
                            gracePeriod: 1 * 60 * 60 * 1000, // 1 hour
                            initialPenalty: 15,
                            recurringPenalty: 5,
                            recurringInterval: 4 * 60 * 60 * 1000 // 4 hours
                        },
                        medium: { 
                            gracePeriod: 4 * 60 * 60 * 1000, // 4 hours
                            initialPenalty: 10,
                            recurringPenalty: 3,
                            recurringInterval: 6 * 60 * 60 * 1000 // 6 hours
                        },
                        low: { 
                            gracePeriod: 12 * 60 * 60 * 1000, // 12 hours
                            initialPenalty: 5,
                            recurringPenalty: 2,
                            recurringInterval: 12 * 60 * 60 * 1000 // 12 hours
                        }
                    };
                    
                    const config = priorityConfig[priority];
                    const overdueTime = now - dueDate;
                    const graceExpired = overdueTime > config.gracePeriod;
                    
                    if (graceExpired) {
                        // Apply initial penalty (one-time)
                        if (!task.initialPenaltyApplied) {
                            let penalty = config.initialPenalty * (1 - streakProtection);
                            penalty = Math.round(penalty);
                            
                            if (healthLossToday + penalty <= maxDailyLoss) {
                                gameState.health = Math.max(minHealth, gameState.health - penalty);
                                healthLossToday += penalty;
                                task.initialPenaltyApplied = true;
                                task.lastPenaltyTime = now;
                            }
                        }
                        
                        // Apply recurring penalties
                        const timeSinceLastPenalty = now - (task.lastPenaltyTime || dueDate + config.gracePeriod);
                        
                        if (timeSinceLastPenalty >= config.recurringInterval) {
                            let penalty = config.recurringPenalty * (1 - streakProtection);
                            penalty = Math.round(penalty);
                            
                            if (healthLossToday + penalty <= maxDailyLoss) {
                                gameState.health = Math.max(minHealth, gameState.health - penalty);
                                healthLossToday += penalty;
                                task.lastPenaltyTime = now;
                            }
                        }
                    }
                }
            });
            
            // Reset daily health loss tracking at midnight
            const today = new Date().toDateString();
            if (gameState.lastHealthResetDate !== today) {
                gameState.lastHealthResetDate = today;
                gameState.dailyHealthLoss = 0;
            }
            
            gameState.dailyHealthLoss = healthLossToday;
            saveGameState();
            updateUI();
        }

        // Health recovery when completing overdue tasks
        function completeTaskHealthBonus(task) {
            if (task.dueDate && task.initialPenaltyApplied) {
                const healthBonus = 10;
                gameState.health = Math.min(100, gameState.health + healthBonus);
                
                // Show health recovery notification
                if (gameState.health < 100) {
                    setTimeout(() => {
                        if (!gameState.healthRecoveryNotificationShown) {
                            alert(`Great job! Jerry recovered ${healthBonus}% health for completing an overdue task! 🌟`);
                            gameState.healthRecoveryNotificationShown = true;
                            saveGameState();
                        }
                    }, 500);
                }
            }
        }

        // ========== GAMIFICATION SYSTEM ==========
        
        // Streak System
        function updateStreak() {
            const today = new Date().toDateString();
            const lastCompletion = gameState.lastCompletionDate;
            
            if (!lastCompletion) {
                // First task completion
                gameState.currentStreak = 1;
                gameState.lastCompletionDate = today;
            } else if (lastCompletion === today) {
                // Already completed a task today, no streak change
                return;
            } else {
                const lastDate = new Date(lastCompletion);
                const todayDate = new Date(today);
                const daysDiff = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 1) {
                    // Consecutive day - extend streak
                    gameState.currentStreak++;
                    gameState.lastCompletionDate = today;
                } else {
                    // Streak broken - reset
                    gameState.currentStreak = 1;
                    gameState.lastCompletionDate = today;
                }
            }
            
            // Update longest streak
            if (gameState.currentStreak > gameState.longestStreak) {
                gameState.longestStreak = gameState.currentStreak;
            }
            
            // Update streak multiplier
            updateStreakMultiplier();
        }
        
        function updateStreakMultiplier() {
            if (gameState.currentStreak >= 7) {
                gameState.streakMultiplier = 3;
            } else if (gameState.currentStreak >= 3) {
                gameState.streakMultiplier = 2;
            } else {
                gameState.streakMultiplier = 1;
            }
        }
        
        // Level System for Jerry
        function addJerryXP(xp) {
            gameState.jerryXP += xp;
            
            // Check for level up
            while (gameState.jerryXP >= gameState.jerryXPToNext) {
                levelUpJerry();
            }
        }
        
        function levelUpJerry() {
            gameState.jerryXP -= gameState.jerryXPToNext;
            gameState.jerryLevel++;
            
            // Increase XP requirement for next level
            gameState.jerryXPToNext = Math.floor(100 * Math.pow(1.2, gameState.jerryLevel - 1));
            
            // Show level up message
            showCongratsMessage(`🎉 ${gameState.rockName} leveled up! Now Level ${gameState.jerryLevel}!`, 0);
            
            // Trigger Jerry's level up response
            setTimeout(() => {
                triggerJerryResponse('levelUp');
            }, 2000);
            
            // Health bonus for leveling up
            gameState.health = Math.min(100, gameState.health + 5);
        }
        
        // Achievement System
        function checkAchievements() {
            const achievements = [
                // Streak achievements
                { id: 'streak_3', name: '🔥 Hot Streak', desc: 'Complete tasks for 3 days in a row', check: () => gameState.currentStreak >= 3 },
                { id: 'streak_7', name: '🔥 Week Warrior', desc: 'Complete tasks for 7 days in a row', check: () => gameState.currentStreak >= 7 },
                { id: 'streak_30', name: '🔥 Month Master', desc: 'Complete tasks for 30 days in a row', check: () => gameState.currentStreak >= 30 },
                
                // Volume achievements
                { id: 'tasks_10', name: '🎯 Getting Started', desc: 'Complete 10 tasks', check: () => gameState.completedTasks >= 10 },
                { id: 'tasks_50', name: '🎯 Task Crusher', desc: 'Complete 50 tasks', check: () => gameState.completedTasks >= 50 },
                { id: 'tasks_100', name: '🎯 Century Club', desc: 'Complete 100 tasks', check: () => gameState.completedTasks >= 100 },
                { id: 'tasks_500', name: '🎯 Task Legend', desc: 'Complete 500 tasks', check: () => gameState.completedTasks >= 500 },
                
                // Level achievements
                { id: 'level_5', name: '⭐ Rising Star', desc: `Reach Level 5 with ${gameState.rockName}`, check: () => gameState.jerryLevel >= 5 },
                { id: 'level_10', name: '⭐ Experienced Rock', desc: `Reach Level 10 with ${gameState.rockName}`, check: () => gameState.jerryLevel >= 10 },
                { id: 'level_20', name: '⭐ Ancient Wisdom', desc: `Reach Level 20 with ${gameState.rockName}`, check: () => gameState.jerryLevel >= 20 }
            ];
            
            achievements.forEach(achievement => {
                if (!gameState.unlockedAchievements.includes(achievement.id) && achievement.check()) {
                    gameState.unlockedAchievements.push(achievement.id);
                    showAchievementUnlocked(achievement);
                }
            });
        }
        
        function showAchievementUnlocked(achievement) {
            // Show achievement notification
            showCongratsMessage(`🏆 Achievement Unlocked!\n${achievement.name}\n${achievement.desc}`, 0);
        }
        
        function updateAchievementsDisplay() {
            const achievements = [
                // Streak achievements
                { id: 'streak_3', name: '🔥 Hot Streak', desc: 'Complete tasks for 3 days in a row', check: () => gameState.currentStreak >= 3 },
                { id: 'streak_7', name: '🔥 Week Warrior', desc: 'Complete tasks for 7 days in a row', check: () => gameState.currentStreak >= 7 },
                { id: 'streak_30', name: '🔥 Month Master', desc: 'Complete tasks for 30 days in a row', check: () => gameState.currentStreak >= 30 },
                
                // Volume achievements
                { id: 'tasks_10', name: '🎯 Getting Started', desc: 'Complete 10 tasks', check: () => gameState.completedTasks >= 10 },
                { id: 'tasks_50', name: '🎯 Task Crusher', desc: 'Complete 50 tasks', check: () => gameState.completedTasks >= 50 },
                { id: 'tasks_100', name: '🎯 Century Club', desc: 'Complete 100 tasks', check: () => gameState.completedTasks >= 100 },
                { id: 'tasks_500', name: '🎯 Task Legend', desc: 'Complete 500 tasks', check: () => gameState.completedTasks >= 500 },
                
                // Level achievements
                { id: 'level_5', name: '⭐ Rising Star', desc: `Reach Level 5 with ${gameState.rockName}`, check: () => gameState.jerryLevel >= 5 },
                { id: 'level_10', name: '⭐ Experienced Rock', desc: `Reach Level 10 with ${gameState.rockName}`, check: () => gameState.jerryLevel >= 10 },
                { id: 'level_20', name: '⭐ Ancient Wisdom', desc: `Reach Level 20 with ${gameState.rockName}`, check: () => gameState.jerryLevel >= 20 }
            ];
            
            const achievementsList = document.getElementById('achievementsList');
            achievementsList.innerHTML = achievements.map(achievement => {
                const isUnlocked = gameState.unlockedAchievements.includes(achievement.id);
                const statusClass = isUnlocked ? 'unlocked' : 'locked';
                const statusText = isUnlocked ? '✓ Unlocked' : 'Locked';
                
                return `
                    <div class="achievement-item ${statusClass}">
                        <div class="achievement-icon">${achievement.name.split(' ')[0]}</div>
                        <div class="achievement-content">
                            <div class="achievement-name">${achievement.name.substring(2)}</div>
                            <div class="achievement-desc">${achievement.desc}</div>
                        </div>
                        <div class="achievement-status">${statusText}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateDailyChallengeDisplay() {
            const challengeDisplay = document.getElementById('dailyChallengeDisplay');
            
            if (!gameState.dailyChallenge) {
                challengeDisplay.innerHTML = `
                    <div class="daily-challenge-card">
                        <div class="challenge-title">No Challenge Today</div>
                        <div class="challenge-desc">Check back tomorrow for a new challenge!</div>
                    </div>
                `;
                return;
            }
            
            const challenge = gameState.dailyChallenge;
            const progressPercent = Math.min(100, (challenge.progress / challenge.target) * 100);
            const isCompleted = gameState.dailyChallengeCompleted;
            
            challengeDisplay.innerHTML = `
                <div class="daily-challenge-card ${isCompleted ? 'challenge-completed' : ''}">
                    <div class="challenge-title">${challenge.name}</div>
                    <div class="challenge-desc">${challenge.desc}</div>
                    <div class="challenge-progress">
                        <div class="challenge-progress-text">Progress: ${challenge.progress}/${challenge.target}</div>
                        <div class="challenge-progress-bar">
                            <div class="challenge-progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    <div class="challenge-reward">
                        ${isCompleted ? '✅ Completed!' : `🎁 Reward: ${challenge.reward} points`}
                    </div>
                </div>
            `;
        }
        
        // Daily Challenges System
        function generateDailyChallenge() {
            const challenges = [
                { id: 'complete_3', name: 'Triple Threat', desc: 'Complete 3 tasks today', target: 3, progress: 0, reward: 50 },
                { id: 'complete_hard', name: 'Challenge Accepted', desc: 'Complete 1 hard task today', target: 1, progress: 0, reward: 75 },
                { id: 'early_bird', name: 'Early Bird', desc: 'Complete a task before 10 AM', target: 1, progress: 0, reward: 40 },
                { id: 'health_80', name: 'Healthy Rock', desc: `Keep ${gameState.rockName}'s health above 80%`, target: 1, progress: 0, reward: 30 }
            ];
            
            const today = new Date().toDateString();
            if (gameState.lastDailyChallengeDate !== today) {
                // Generate new daily challenge
                const randomChallenge = challenges[Math.floor(Math.random() * challenges.length)];
                gameState.dailyChallenge = randomChallenge;
                gameState.dailyChallengeCompleted = false;
                gameState.lastDailyChallengeDate = today;
            }
        }
        
        function updateDailyChallengeProgress() {
            if (!gameState.dailyChallenge || gameState.dailyChallengeCompleted) return false;
            
            const challenge = gameState.dailyChallenge;
            let progressMade = false;
            
            // Check different challenge types
            switch (challenge.id) {
                case 'complete_3':
                    // Count tasks completed today
                    const today = new Date().toDateString();
                    if (gameState.lastCompletionDate === today) {
                        challenge.progress = Math.min(challenge.target, challenge.progress + 1);
                        progressMade = true;
                    }
                    break;
                    
                case 'complete_hard':
                    // This would be checked when completing a hard task
                    // For now, we'll increment on any task completion
                    challenge.progress = Math.min(challenge.target, challenge.progress + 1);
                    progressMade = true;
                    break;
                    
                case 'early_bird':
                    // Check if current time is before 10 AM
                    const currentHour = new Date().getHours();
                    if (currentHour < 10) {
                        challenge.progress = Math.min(challenge.target, challenge.progress + 1);
                        progressMade = true;
                    }
                    break;
                    
                case 'health_80':
                    // Check if health is above 80%
                    if (gameState.health >= 80) {
                        challenge.progress = Math.min(challenge.target, challenge.progress + 1);
                        progressMade = true;
                    }
                    break;
            }
            
            // Check if challenge is completed
            if (challenge.progress >= challenge.target && !gameState.dailyChallengeCompleted) {
                gameState.dailyChallengeCompleted = true;
                gameState.taskPoints += challenge.reward;
                
                // Play celebration sound for daily challenge completion
                playDailyChallengeCompleteSound();
                
                showCongratsMessage(`⚡ Daily Challenge Complete!\n${challenge.name}\n+${challenge.reward} bonus points!`, challenge.reward);
                return true; // Return true to indicate daily challenge was completed
            }
            
            return false; // Return false if no daily challenge was completed
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadGameState();
            generateDailyChallenge();
            updateUI();
            checkHealthPenalties();
            
            // Initialize notification toggle state explicitly
            setTimeout(() => {
                const notificationToggle = document.getElementById('notificationToggle');
                if (notificationToggle) {
                    notificationToggle.checked = gameState.taskNotificationsEnabled;
                    console.log('Task Rock: Notification toggle initialized to:', gameState.taskNotificationsEnabled);
                }
            }, 100);
            
            // Initialize Jerry's dialogue system (includes notification system)
            initializeJerryDialogue();
            
            // Initialize hydration reminders
            initializeHydrationReminders();
            
            // Set up periodic health checks
            setInterval(checkHealthPenalties, 60000); // Check every minute
        });

        // Edit rock name function
        function editRockName() {
            const nameDiv = document.getElementById('rockName');
            const nameInput = document.getElementById('rockNameInput');
            
            nameDiv.style.display = 'none';
            nameInput.style.display = 'block';
            nameInput.value = gameState.rockName;
            nameInput.focus();
            nameInput.select();
        }

        function saveRockName() {
            const nameDiv = document.getElementById('rockName');
            const nameInput = document.getElementById('rockNameInput');
            const newName = nameInput.value.trim();
            
            if (newName !== '' && newName !== gameState.rockName) {
                gameState.rockName = newName;
                saveGameState();
            }
            
            nameInput.style.display = 'none';
            nameDiv.style.display = 'block';
            updateUI();
        }

        function handleRockNameKeypress(event) {
            if (event.key === 'Enter') {
                saveRockName();
            } else if (event.key === 'Escape') {
                const nameDiv = document.getElementById('rockName');
                const nameInput = document.getElementById('rockNameInput');
                nameInput.style.display = 'none';
                nameDiv.style.display = 'block';
            }
        }

        // Horizontal scroll functionality for shop grids
        function initializeHorizontalScroll() {
            const scrollableGrids = document.querySelectorAll('.shop-grid.scrollable');
            
            scrollableGrids.forEach(grid => {
                // Mouse wheel horizontal scrolling
                grid.addEventListener('wheel', function(e) {
                    if (e.deltaY !== 0) {
                        e.preventDefault();
                        grid.scrollLeft += e.deltaY;
                    }
                });

                // Touch scrolling for mobile
                let isDown = false;
                let startX;
                let scrollLeft;

                grid.addEventListener('mousedown', (e) => {
                    isDown = true;
                    grid.style.cursor = 'grabbing';
                    startX = e.pageX - grid.offsetLeft;
                    scrollLeft = grid.scrollLeft;
                });

                grid.addEventListener('mouseleave', () => {
                    isDown = false;
                    grid.style.cursor = 'grab';
                });

                grid.addEventListener('mouseup', () => {
                    isDown = false;
                    grid.style.cursor = 'grab';
                });

                grid.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - grid.offsetLeft;
                    const walk = (x - startX) * 2;
                    grid.scrollLeft = scrollLeft - walk;
                });

                // Set initial cursor
                grid.style.cursor = 'grab';
            });
        }

        // Initialize horizontal scroll when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeHorizontalScroll();
        });

        // Clear Data Functions
        function showPartialResetModal() {
            document.getElementById('partialResetModal').style.display = 'block';
        }

        function closePartialResetModal() {
            document.getElementById('partialResetModal').style.display = 'none';
            // Reset checkboxes
            document.querySelectorAll('#partialResetModal input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function showFullResetModal() {
            document.getElementById('fullResetModal').style.display = 'block';
        }

        function closeFullResetModal() {
            document.getElementById('fullResetModal').style.display = 'none';
            document.getElementById('deleteConfirmation').value = '';
        }

        function executePartialReset() {
            const resetTasks = document.getElementById('resetTasks').checked;
            const resetAchievements = document.getElementById('resetAchievements').checked;
            const resetShop = document.getElementById('resetShop').checked;
            const resetLevel = document.getElementById('resetLevel').checked;
            const resetStreaks = document.getElementById('resetStreaks').checked;

            if (!resetTasks && !resetAchievements && !resetShop && !resetLevel && !resetStreaks) {
                alert('Please select at least one option to reset.');
                return;
            }

            if (confirm('Are you sure you want to reset the selected data? This cannot be undone.')) {
                if (resetTasks) {
                    gameState.tasks = [];
                    gameState.completedTasks = 0;
                    gameState.taskPoints = 0;
                }

                if (resetAchievements) {
                    gameState.achievements = [];
                    gameState.unlockedAchievements = [];
                }

                if (resetShop) {
                    gameState.ownedItems = [];
                    gameState.equippedItems = [];
                }

                if (resetLevel) {
                    gameState.jerryLevel = 1;
                    gameState.jerryXP = 0;
                    gameState.jerryXPToNext = 100;
                }

                if (resetStreaks) {
                    gameState.currentStreak = 0;
                    gameState.longestStreak = 0;
                    gameState.lastCompletionDate = null;
                }

                // Reset health and other dependent values
                if (resetTasks || resetLevel) {
                    gameState.health = 100;
                    gameState.isDead = false;
                    gameState.revivalPoints = 0;
                }

                saveGameState();
                updateUI();
                closePartialResetModal();
                
                alert('Selected data has been reset successfully!');
            }
        }

        function executeFullReset() {
            const confirmation = document.getElementById('deleteConfirmation').value;
            
            if (confirmation !== 'DELETE') {
                alert('Please type "DELETE" to confirm.');
                return;
            }

            if (confirm('FINAL WARNING: This will permanently delete ALL your Task Rock data. Are you absolutely sure?')) {
                // Clear localStorage completely
                localStorage.removeItem('taskRockGameState');
                
                // Reset gameState to initial values
                gameState = {
                    health: 100,
                    taskPoints: 0,
                    tasks: [],
                    completedTasks: 0,
                    ownedItems: [],
                    equippedItems: [],
                    rockName: 'Jerry',
                    lastTaskCheck: Date.now(),
                    isDead: false,
                    revivalPoints: 0,
                    healthNotificationShown: false,
                    currentStreak: 0,
                    longestStreak: 0,
                    lastCompletionDate: null,
                    streakMultiplier: 1,
                    achievements: [],
                    unlockedAchievements: [],
                    jerryLevel: 1,
                    jerryXP: 0,
                    jerryXPToNext: 100,
                    dailyChallenge: null,
                    dailyChallengeCompleted: false,
                    lastDailyChallengeDate: null
                };

                saveGameState();
                closeFullResetModal();
                
                // Reload the page to show fresh state
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }

        // Email Modal Functions
        function checkAndShowEmailModal() {
            console.log('Checking email modal...');
            console.log('Email submitted:', gameState.emailSubmitted);
            console.log('Current app open count:', gameState.appOpenCount);
            
            // Don't show if email already submitted
            if (gameState.emailSubmitted) {
                console.log('Email already submitted, skipping modal');
                return;
            }

            // Increment app open count
            gameState.appOpenCount = (gameState.appOpenCount || 0) + 1;
            console.log('New app open count:', gameState.appOpenCount);
            
            // Show modal every 3rd open
            if (gameState.appOpenCount % 3 === 0) {
                console.log('Showing email modal!');
                document.getElementById('emailModal').style.display = 'block';
            } else {
                console.log('Not time for modal yet, need', 3 - (gameState.appOpenCount % 3), 'more opens');
            }
            
            saveGameState();
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        function skipEmailModal() {
            closeEmailModal();
            // Reset counter so it shows again in 3 more opens
            gameState.appOpenCount = 0;
            saveGameState();
        }

        // Handle email form submission
        document.addEventListener('DOMContentLoaded', function() {
            const emailForm = document.getElementById('emailForm');
            
             emailForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const userName = document.getElementById('userName').value.trim();
                const userEmail = document.getElementById('userEmail').value.trim();
                
                if (!userEmail || !userEmail.includes('@')) {
                    alert('Please enter a valid email address.');
                    return;
                }

                // Save user's name to game state if provided
                if (userName) {
                    gameState.userName = userName;
                    saveGameState();
                }

                // Show success message with personalization
                const successMessage = userName 
                    ? `Thanks ${userName}! You're all set for exclusive updates!`
                    : 'Thanks! You\'re all set for exclusive updates!';
                
                alert(successMessage);
                
                // Trigger Jerry's personalized response
                if (userName) {
                    setTimeout(() => {
                        triggerJerryResponse(`Hey ${userName}! I'm excited to have you on board! 🗿`);
                    }, 1000);
                } else {
                    setTimeout(() => {
                        triggerJerryResponse('Welcome aboard! Ready to rock some tasks together? 🗿');
                    }, 1000);
                }
                
                closeEmailModal();
            });
        });

        // Check for email modal on page load
        setTimeout(checkAndShowEmailModal, 1000);

        // Close modals when clicking outside
        window.onclick = function(event) {
            const partialModal = document.getElementById('partialResetModal');
            const fullModal = document.getElementById('fullResetModal');
            const emailModal = document.getElementById('emailModal');
            
            if (event.target == partialModal) {
                closePartialResetModal();
            }
            if (event.target == fullModal) {
                closeFullResetModal();
            }
            if (event.target == emailModal) {
                closeEmailModal();
            }
        }

        // Firebase Service Worker Registration is handled in initializeFCM function

            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'SYNC_COMPLETE') {
                    console.log('Task Rock: Background sync completed');
                }
                
                // Handle storage data requests from service worker
                if (event.data && event.data.type === 'GET_STORAGE_DATA') {
                    const key = event.data.key;
                    let data = null;
                    
                    try {
                        if (key === 'taskRockGameState') {
                            data = gameState;
                        } else {
                            data = JSON.parse(localStorage.getItem(key));
                        }
                    } catch (error) {
                        console.error('Task Rock: Error getting storage data', error);
                    }
                    
                    // Send data back to service worker
                    event.ports[0].postMessage(data);
                }
                
                // Handle storage data updates from service worker
                if (event.data && event.data.type === 'SET_STORAGE_DATA') {
                    const key = event.data.key;
                    const data = event.data.data;
                    
                    try {
                        if (key === 'taskRockGameState') {
                            // Update the global gameState
                            Object.assign(gameState, data);
                            saveGameState();
                        } else {
                            localStorage.setItem(key, JSON.stringify(data));
                        }
                    } catch (error) {
                        console.error('Task Rock: Error setting storage data', error);
                    }
                }
                
                // Handle notification click events from service worker
                if (event.data && event.data.type === 'notification_click') {
                    console.log('Task Rock: Notification clicked', event.data);
                    
                    if (event.data.action === 'complete' && event.data.taskId) {
                        // Complete the task
                        const task = gameState.tasks.find(t => t.id === event.data.taskId);
                        if (task) {
                            completeTask(task.id);
                            showJerryDialog(`Great job! You completed "${task.title}" from the notification! 🎉`);
                        }
                    } else if (event.data.action === 'view' && event.data.taskId) {
                        // Scroll to and highlight the task
                        const task = gameState.tasks.find(t => t.id === event.data.taskId);
                        if (task) {
                            // Expand tasks section if collapsed
                            const tasksSection = document.getElementById('tasks-section');
                            if (tasksSection && !tasksSection.classList.contains('expanded')) {
                                toggleSection('tasks');
                            }
                            
                            // Show Jerry message about the task
                            showJerryDialog(`Here's your task: "${task.title}". ${task.description || 'Time to get it done!'} 🗿`);
                        }
                    }
                }
            });
            
            // Register background sync for task notifications
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then(registration => {
                    // Register periodic background sync for task checking
                    setInterval(() => {
                        registration.sync.register('check-due-tasks').catch(error => {
                            console.log('Task Rock: Background sync registration failed', error);
                        });
                    }, 60000); // Check every minute for background sync
                    
                    console.log('Task Rock: Background sync for notifications registered');
                });
            }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('Task Rock: Install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show custom install button (you can add this to your UI)
            // showInstallButton();
        });

        // Handle PWA installation
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Task Rock: PWA installed');
                    } else {
                        console.log('Task Rock: PWA installation declined');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // === Jerry Dialogue System ===

        // Jerry's full dialogue object (expandable) with personalized variations
        const jerryDialogues = {
            greetings: [
                "Hey there, Rock Star! Let's roll.",
                "Back so soon? I like your style.",
                "Jerry missed you. But not too much. I'm still a rock.",
                "Ooooh, we doing things today? I'm ready!",
                "You again! Let's crush some tasks.",
                "Welcome back, pebble pal.",
                "Rise and grind — or at least poke a checkbox or two."
            ],

            // Personalized greetings when user name is available
            personalizedGreetings: [
                "Hey {name}! Ready to rock some tasks together?",
                "Welcome back, {name}! Let's make today productive!",
                "{name}, my favorite human! Time to get things done!",
                "Oh hey {name}! I've been waiting for you to come back!",
                "Look who's here! It's {name}! Let's crush this day!",
                "{name}! Ready to show these tasks who's boss?",
                "Hey {name}, let's turn today into a masterpiece!"
            ],

            health: {
                high: [
                    "Feeling solid as slate today!",
                    "Peak condition, baby! Let's keep it that way.",
                    "No cracks, no worries.",
                    "I could smash a mountain right now!"
                ],
                // Personalized high health messages
                personalizedHigh: [
                    "Feeling great, {name}! Ready for anything!",
                    "{name}, I'm in peak condition! Let's tackle those tasks!",
                    "Solid as a rock, {name}! What's our next move?",
                    "Hey {name}, I'm feeling unstoppable today!"
                ],
                mid: [
                    "I'm doing okay, but a few tasks would help.",
                    "Could go for a good stretch… or a small win.",
                    "Half full, half cracked. Your call.",
                    "You and I? We're getting through it."
                ],
                // Personalized mid health messages
                personalizedMid: [
                    "{name}, I could use a little boost. Help me out?",
                    "Hey {name}, feeling a bit worn. A task or two would help!",
                    "{name}, I'm hanging in there, but could use your help.",
                    "Not my best day, {name}, but together we can fix this!"
                ],
                low: [
                    "I'm chipping, friend… just a few tasks, please.",
                    "Even a rock needs TLC. Can you help me?",
                    "Feeling fragile today… but I believe in you.",
                    "Don't let me crumble. You've got this."
                ],
                // Personalized low health messages
                personalizedLow: [
                    "{name}, I'm really struggling here. Please help me!",
                    "Hey {name}, I need you more than ever right now.",
                    "{name}, I'm counting on you to help me recover.",
                    "Please {name}, don't let me crumble. I believe in you!"
                ]
            },

            // Health-based mood dialogue with specific thresholds
            healthMood: {
                confident: [
                    "Still solid. Nothing I can't handle!",
                    "Feeling strong and ready for anything!",
                    "Rock solid and ready to roll!"
                ],
                personalizedConfident: [
                    "{name}, I'm feeling unstoppable! Let's do this!",
                    "Hey {name}, I'm rock solid and ready for action!",
                    "{name}, nothing can stop us when we work together!"
                ],
                slightlyWary: [
                    "Hmm... might be a few cracks showing.",
                    "Starting to feel a little worn, but I'm hanging in there.",
                    "Could use a little boost, but I'm still here!"
                ],
                personalizedSlightlyWary: [
                    "{name}, I'm starting to feel a bit rough around the edges.",
                    "Hey {name}, could use some of your magic touch!",
                    "{name}, I'm still strong, but could use your help soon."
                ],
                cautious: [
                    "Okay, starting to feel that…",
                    "Things are getting a bit rough around the edges.",
                    "I'm holding together, but barely."
                ],
                personalizedCautious: [
                    "{name}, I'm getting worried. Can you help me?",
                    "Hey {name}, things are getting tough for me.",
                    "{name}, I really need your support right now."
                ],
                anxious: [
                    "Chipping away at me, huh?",
                    "This is getting concerning... I need some help.",
                    "The cracks are starting to show more."
                ],
                personalizedAnxious: [
                    "{name}, I'm really scared. Please don't abandon me!",
                    "Hey {name}, I'm falling apart. I need you!",
                    "{name}, please help me before it's too late!"
                ],
                low: [
                    "I don't feel so rock-solid anymore…",
                    "My foundation is shaking... literally.",
                    "This isn't looking good for me."
                ],
                personalizedLow: [
                    "{name}, I'm barely holding on. Save me!",
                    "Hey {name}, I'm in serious trouble here!",
                    "{name}, I'm counting on you to rescue me!"
                ],
                weak: [
                    "Oof... this might be it for me…",
                    "I'm barely holding together here.",
                    "Everything hurts, even for a rock."
                ],
                personalizedWeak: [
                    "{name}, I don't know how much longer I can last...",
                    "Hey {name}, I'm at my breaking point!",
                    "{name}, please... I need you now more than ever!"
                ],
                desperate: [
                    "I'm crumbling here… help?",
                    "Please... I can't take much more of this.",
                    "Save me before I turn to dust!"
                ],
                personalizedDesperate: [
                    "{name}, I'm begging you... save me!",
                    "Hey {name}, this is my last cry for help!",
                    "{name}, please don't let me become dust!"
                ]
            },

            habitResponses: {
                "Drink Water": [
                    "Hydrated and proud 💧",
                    "You drank, I thrived. Symbiosis!",
                    "Jerry approves of the liquid courage!"
                ],
                personalizedDrinkWater: [
                    "Great job staying hydrated, {name}! 💧",
                    "{name}, you're taking care of yourself! I'm proud!",
                    "Way to go, {name}! Hydration is key!"
                ],
                "Stretch": [
                    "Ahh, even rocks like to loosen up a bit 🧘",
                    "Flex those muscles! I'll pretend I have those too."
                ],
                personalizedStretch: [
                    "Nice stretch, {name}! Wish I could join you! 🧘",
                    "{name}, taking care of your body! Smart move!",
                    "Love seeing you stretch, {name}! Keep it up!"
                ],
                "Read": [
                    "Words! You used words! I'm proud.",
                    "Reading is the weightlifting of the mind. Rock on!"
                ],
                personalizedRead: [
                    "Reading again, {name}? You're so smart!",
                    "{name}, expanding that brilliant mind of yours!",
                    "Love that you're reading, {name}! Knowledge rocks!"
                ],
                default: [
                    "Another one down! You're unstoppable.",
                    "You keep doing you — I'll be here vibin'.",
                    "Pebble by pebble, you're making a path."
                ],
                personalizedDefault: [
                    "Another win for {name}! You're amazing!",
                    "{name}, you're absolutely crushing it!",
                    "Way to go, {name}! I'm so proud of you!"
                ]
            },

            streaks: {
                habits: [
                    "🔥 That's a solid habit streak you've got!",
                    "Every day you get better. I'm impressed!"
                ],
                personalizedHabits: [
                    "🔥 {name}, your streak is incredible!",
                    "{name}, you're building amazing habits! So proud!",
                    "Look at that streak, {name}! You're unstoppable! 🔥"
                ],
                tasks: [
                    "Task streaks are heating up! 🔥",
                    "You're unstoppable lately!"
                ],
                personalizedTasks: [
                    "{name}, your task streak is on fire! 🔥",
                    "Wow {name}, you're absolutely unstoppable!",
                    "{name}, this streak is legendary! Keep it up! 🔥"
                ]
            },

            idle: [
                "Still here… just thinking about quartz.",
                "You ever wonder if sand misses being a rock?",
                "If I had legs, I'd be out walking. Just sayin'.",
                "Silence is cool, but progress is cooler."
            ],

            personalizedIdle: [
                "Hey {name}, still here thinking about you!",
                "{name}, just wondering what you're up to...",
                "Missing you, {name}! Come back soon!",
                "{name}, I'm here whenever you're ready to rock!"
            ],

            motivation: [
                "You've done hard things before. This is no different.",
                "Don't measure today by size. Measure by intent.",
                "I believe in you. And I'm made of actual stone.",
                "One task is better than none. That's progress.",
                "You're tougher than granite—keep going!",
                "Every pebble makes a mountain.",
                "Rock bottom just means there's nowhere to go but up!",
                "Small steps still move mountains.",
                "You're more resilient than you think.",
                "Progress isn't always visible, but it's always happening.",
                "Even diamonds start as coal under pressure.",
                "Your potential is limitless, unlike my mobility.",
                "Every expert was once a beginner.",
                "Consistency beats perfection every time.",
                "You're building something amazing, one day at a time.",
                "Challenges are just opportunities wearing disguises.",
                "Your future self is cheering you on right now.",
                "Mistakes are proof you're trying.",
                "Growth happens outside your comfort zone.",
                "You're stronger than your strongest excuse.",
                "Success is a series of small wins.",
                "Your only competition is who you were yesterday.",
                "Believe in yourself as much as I believe in you.",
                "Every setback is a setup for a comeback.",
                "You're not stuck, you're just getting started.",
                "Dreams don't work unless you do.",
                "The best time to start was yesterday. The second best time is now.",
                "You're capable of more than you realize.",
                "Persistence is the key that unlocks every door.",
                "Your effort today shapes your tomorrow.",
                "Small actions lead to big results.",
                "You're writing your own success story.",
                "Every day is a chance to get better.",
                "Your mindset determines your outcome.",
                "Focus on progress, not perfection.",
                "You're exactly where you need to be right now.",
                "Courage isn't the absence of fear, it's action despite it.",
                "Your potential is like a rock—solid and unbreakable.",
                "Keep going, you're closer than you think.",
                "Success is built one habit at a time.",
                "You're not behind, you're on your own timeline.",
                "Every challenge makes you stronger.",
                "Your determination is your superpower.",
                "Great things take time, just like rock formation.",
                "You're planting seeds for future success.",
                "Believe in the process, trust the journey.",
                "Your consistency is your competitive advantage.",
                "You're building momentum with every step.",
                "Obstacles are stepping stones in disguise.",
                "Your effort is never wasted.",
                "You're more capable than you give yourself credit for.",
                "Success starts with a single decision to try.",
                "You're creating positive change in your life.",
                "Every day you don't quit is a victory.",
                "Your persistence will pay off.",
                "You're stronger than any challenge you face.",
                "Progress is progress, no matter how small.",
                "You're on the right path, keep walking.",
                "Your dedication is inspiring, even to a rock.",
                "You're building character with every challenge.",
                "Success is a journey, not a destination.",
                "You're exactly as strong as you need to be.",
                "Your efforts today create tomorrow's opportunities.",
                "You're not just surviving, you're thriving.",
                "Every step forward is a step toward your goals.",
                "You're creating the life you want to live.",
                "Your resilience is remarkable.",
                "You're making a difference, one task at a time.",
                "Success is the sum of small efforts repeated daily.",
                "You're building something beautiful with your life.",
                "Your potential is unlimited, unlike my movement.",
                "You're stronger than you were yesterday.",
                "Every challenge is a chance to grow.",
                "You're writing a story of perseverance.",
                "Your commitment to growth is admirable.",
                "You're creating positive momentum.",
                "Success is earned through consistent effort.",
                "You're building the foundation for your dreams.",
                "Your determination is unshakeable, like me.",
                "You're making progress even when you can't see it.",
                "Every effort counts toward your success.",
                "You're developing strength through challenges.",
                "Your journey is unique and valuable.",
                "You're creating opportunities through action.",
                "Success is a habit you're building daily.",
                "You're more resilient than any obstacle.",
                "Your efforts are shaping your future.",
                "You're building confidence with every step.",
                "Every day is a new chance to excel.",
                "You're creating positive change through persistence.",
                "Your dedication will lead to breakthrough.",
                "You're stronger than your doubts.",
                "Success is the result of preparation meeting opportunity.",
                "You're building a legacy of perseverance.",
                "Your efforts today echo into tomorrow.",
                "You're creating momentum through consistency.",
                "Every challenge overcome makes you stronger.",
                "You're writing your own success manual.",
                "Your potential is as solid as bedrock.",
                "You're building something amazing, trust the process.",
                "Success is earned through daily commitment.",
                "You're stronger than any temporary setback.",
                "Your journey is proof of your strength.",
                "You're creating the future you envision.",
                "Every effort is a building block of success.",
                "You're developing unstoppable momentum.",
                "Your persistence is your greatest asset.",
                "You're building character through challenges.",
                "Success is the reward for consistent effort."
            ],

            // Personalized motivational messages
            personalizedMotivation: [
                "{name}, you've got this! I believe in you completely!",
                "Hey {name}, you're stronger than you know!",
                "{name}, every step you take makes me proud!",
                "You're amazing, {name}! Keep pushing forward!",
                "{name}, I've seen what you can do - you're unstoppable!",
                "Hey {name}, your determination inspires even a rock like me!",
                "{name}, you're building something incredible!",
                "Keep going, {name}! Your future self will thank you!",
                "{name}, you're more capable than you realize!",
                "Hey {name}, every challenge makes you stronger!",
                "{name}, your persistence is your superpower!",
                "You're writing an amazing story, {name}!",
                "{name}, I'm so proud of how far you've come!",
                "Hey {name}, you're exactly where you need to be!",
                "{name}, your potential is limitless!",
                "Keep shining, {name}! You're doing great!",
                "{name}, every effort you make counts!",
                "Hey {name}, you're building momentum every day!",
                "{name}, your dedication is truly inspiring!",
                "You're creating positive change, {name}!"
            ],

            sleep: [
                "Time to rest, friend. Even rocks need downtime.",
                "Let's call it a night. You've done enough.",
                "Close the app. Recharge. I'll be here tomorrow."
            ],

            personalizedSleep: [
                "Good night, {name}! Rest well, you've earned it!",
                "Sweet dreams, {name}! I'll be here when you wake up!",
                "Time to recharge, {name}! See you tomorrow!",
                "Sleep tight, {name}! Tomorrow's another day to rock!"
            ],

            taskCompletion: [
                "Rock solid work! 🪨",
                "That's how we roll!",
                "Another one bites the dust!",
                "You're on fire! 🔥",
                "Crushing it like a landslide!",
                "Smooth as a river stone!",
                "You rock! Literally, I'm a rock."
            ],

            personalizedTaskCompletion: [
                "Fantastic work, {name}! 🪨",
                "{name}, you absolutely crushed that task!",
                "Way to go, {name}! That's how it's done!",
                "Amazing job, {name}! You're on fire! 🔥",
                "{name}, you make it look so easy!",
                "Brilliant work, {name}! I'm so proud!",
                "{name}, you rock harder than me! And I'm literally a rock!"
            ],

            taskCreation: [
                "New task? I'm ready to help you tackle it!",
                "Let's add some structure to this day!",
                "Another goal to crush? Count me in!",
                "Building momentum, one task at a time!"
            ],

            personalizedTaskCreation: [
                "New task, {name}? Let's crush it together!",
                "{name}, I love seeing you plan ahead!",
                "Another goal for {name}? I'm excited to help!",
                "{name}, you're so organized! Let's do this!"
            ],

            // Item-specific dialogue when Jerry gets equipped with items
            itemEquipped: {
                // Hat responses
                blueHat: [
                    "Blue hat? I'm feeling quite distinguished!",
                    "This blue brings out my rocky complexion!",
                    "Looking sharp in blue! Ready for business!",
                    "Blue is my color! Let's get things done!"
                ],
                personalizedBlueHat: [
                    "{name}, how do I look in blue? Pretty sharp, right?",
                    "Thanks for the blue hat, {name}! I feel distinguished!",
                    "{name}, this blue really brings out my rocky charm!"
                ],
                topHat: [
                    "Feeling dapper in this top hat!",
                    "Class never goes out of style.",
                    "A gentleman rock at your service!",
                    "Fancy hat for fancy tasks! Let's be productive!",
                    "I feel so sophisticated! Time to tackle some classy tasks!",
                    "Top hat, top performance! Let's roll!"
                ],
                personalizedTopHat: [
                    "{name}, I feel like a distinguished gentleman in this top hat!",
                    "Thanks for the classy upgrade, {name}! I'm ready for anything!",
                    "{name}, with this top hat, I'm ready to tackle sophisticated tasks!"
                ],
                armyHelmet: [
                    "Reporting for duty! Ready to battle those tasks!",
                    "Military precision mode activated!",
                    "Let's march through that to-do list, soldier!",
                    "Tactical Jerry is ready for mission success!"
                ],
                personalizedArmyHelmet: [
                    "Reporting for duty, {name}! Ready for battle!",
                    "{name}, tactical Jerry is ready for mission success!",
                    "Thanks for the gear, {name}! Let's march through those tasks!"
                ],
                wizardHat: [
                    "Abracadabra! Let's make those tasks disappear!",
                    "Magical productivity powers activated!",
                    "With this wizard hat, I can help you conjure some serious progress!",
                    "Time to cast some productivity spells!"
                ],
                personalizedWizardHat: [
                    "Abracadabra, {name}! Let's make your tasks disappear!",
                    "{name}, with this wizard hat, I can help you conjure amazing progress!",
                    "Thanks for the magical upgrade, {name}! Time to cast productivity spells!"
                ],
                
                // Accessory responses
                readingGlasses: [
                    "Now I can see your tasks crystal clear!",
                    "These glasses make everything look more doable!",
                    "Smart Jerry is ready to help you focus!",
                    "With better vision comes better productivity!"
                ],
                personalizedReadingGlasses: [
                    "Now I can see {name}'s tasks crystal clear!",
                    "{name}, these glasses make your goals look so achievable!",
                    "Thanks for the specs, {name}! Smart Jerry is ready to help!"
                ],
                sunglasses: [
                    "Looking cool while staying productive!",
                    "Too cool for procrastination!",
                    "Shades on, tasks done! Let's go!",
                    "Cool Jerry is ready to rock your day!"
                ],
                personalizedSunglasses: [
                    "{name}, I'm looking cool and ready to rock your day!",
                    "Thanks for the shades, {name}! Too cool for procrastination!",
                    "{name}, cool Jerry is ready to help you shine!"
                ],
                mustache: [
                    "Distinguished Jerry at your service!",
                    "This mustache gives me wisdom... and style!",
                    "Fancy facial hair for fancy task completion!",
                    "Mustache Jerry is ready to handle business!"
                ],
                personalizedMustache: [
                    "Distinguished Jerry at your service, {name}!",
                    "{name}, this mustache gives me wisdom to help you better!",
                    "Thanks for the distinguished look, {name}! Ready for business!"
                ],
                
                // Paint job responses
                buddyPaint: [
                    "Feeling fresh with this new look!",
                    "Buddy Paint makes everything better!",
                    "Ready to tackle tasks with style!",
                    "This paint job gives me extra motivation!"
                ],
                personalizedBuddyPaint: [
                    "{name}, I'm feeling fresh and ready to be your best buddy!",
                    "Thanks for the makeover, {name}! Buddy Paint makes everything better!",
                    "{name}, with this new look, I'm ready to tackle anything with you!"
                ],
                rockStarPaint: [
                    "Rock and roll, baby! Let's get productive!",
                    "Feeling like a productivity rock star!",
                    "This paint job rocks my world!",
                    "Ready to rock these tasks!"
                ],
                personalizedRockStarPaint: [
                    "Rock and roll, {name}! Let's get productive together!",
                    "{name}, I'm feeling like a productivity rock star!",
                    "Thanks for the rock star makeover, {name}! Ready to rock!"
                ],
                makeupPaint: [
                    "Glamorous Jerry is ready for action!",
                    "Looking fabulous and feeling productive!",
                    "This makeup makes me feel unstoppable!",
                    "Beauty and productivity go hand in hand!"
                ],
                personalizedMakeupPaint: [
                    "Glamorous Jerry is ready for action, {name}!",
                    "{name}, I'm looking fabulous and feeling productive!",
                    "Thanks for the glam makeover, {name}! I feel unstoppable!"
                ],
                
                // Combination responses for multiple items
                multipleItems: [
                    "Wow, I'm all dressed up! Let's make this day count!",
                    "Looking good, feeling good, ready to be productive!",
                    "With all this gear, I'm unstoppable!",
                    "Fully equipped Jerry is ready for maximum productivity!"
                ],
                personalizedMultipleItems: [
                    "Wow {name}, I'm all dressed up thanks to you! Let's make this day count!",
                    "{name}, you've got me looking good and feeling great!",
                    "Thanks for all the gear, {name}! I'm unstoppable now!",
                    "{name}, fully equipped Jerry is ready for maximum productivity!"
                ]
            },

            // Hydration reminders (new feature)
            hydrationReminders: [
                "💧 Hey there! Time for a water break! Your body (and I) will thank you!",
                "🚰 Hydration station time! Even rocks appreciate good water flow!",
                "💦 Don't forget to drink some water! Stay hydrated, stay productive!",
                "🌊 Water break reminder! Keep those energy levels flowing!",
                "💧 Time to refuel with some H2O! Your brain needs it!",
                "🚰 Jerry's hydration reminder: Drink up, buttercup!",
                "💦 Staying hydrated = staying focused! Time for some water!",
                "🌊 Your hourly hydration check-in! Don't let Jerry down!"
            ],

            personalizedHydrationReminders: [
                "💧 Hey {name}! Time for a water break! Your body will thank you!",
                "🚰 {name}, hydration station time! Even rocks appreciate good water flow!",
                "💦 Don't forget to drink some water, {name}! Stay hydrated!",
                "🌊 Water break reminder for {name}! Keep those energy levels flowing!",
                "💧 Time to refuel with some H2O, {name}! Your brain needs it!",
                "🚰 Jerry's hydration reminder for {name}: Drink up!",
                "💦 {name}, staying hydrated = staying focused! Time for some water!",
                "🌊 Your hourly hydration check-in, {name}! Don't let Jerry down!"
            ],

            levelUp: [
                "Level up! I'm getting stronger! 💪",
                "New level unlocked! We're unstoppable!",
                "Growing stronger together! 🌟",
                "This rock is evolving!"
            ],

            personalizedLevelUp: [
                "Level up, {name}! We're getting stronger together! 💪",
                "{name}, new level unlocked! We're unstoppable!",
                "Growing stronger with {name}! 🌟",
                "{name}, this rock is evolving thanks to you!"
            ],

            shopping: [
                "Ooh, shopping time! Make me look fabulous! ✨",
                "New gear? I'm ready for a makeover!",
                "Style points incoming! 🎩",
                "Fashion rock is the best rock!"
            ],

            personalizedShopping: [
                "Ooh {name}, shopping time! Make me look fabulous! ✨",
                "{name}, new gear? I'm ready for a makeover!",
                "Style points incoming thanks to {name}! 🎩",
                "{name}, you always know how to make me look good!"
            ]
        };

        // Get random message from category with personalization support
        function getRandomMessage(category, subkey = null) {
            const source = jerryDialogues[category];
            if (!source) return "💬";
            
            let messages;
            const userName = gameState.userName;
            
            if (subkey) {
                // Handle subcategories (like health.high, health.mid, etc.)
                if (userName && source[`personalized${subkey.charAt(0).toUpperCase() + subkey.slice(1)}`]) {
                    // Use personalized version if user name exists
                    messages = source[`personalized${subkey.charAt(0).toUpperCase() + subkey.slice(1)}`];
                } else {
                    messages = source[subkey];
                }
            } else {
                // Handle main categories
                if (userName && jerryDialogues[`personalized${category.charAt(0).toUpperCase() + category.slice(1)}`]) {
                    // Use personalized version if user name exists
                    messages = jerryDialogues[`personalized${category.charAt(0).toUpperCase() + category.slice(1)}`];
                } else {
                    messages = Array.isArray(source) ? source : source.default || [];
                }
            }
            
            if (!messages || !Array.isArray(messages) || messages.length === 0) {
                return "💬";
            }
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            // Replace {name} placeholder with actual user name
            if (userName && randomMessage.includes('{name}')) {
                return randomMessage.replace(/{name}/g, userName);
            }
            
            return randomMessage;
        }

        // Get personalized habit response
        function getPersonalizedHabitResponse(habitTitle) {
            const userName = gameState.userName;
            
            // Check for specific habit responses
            if (userName) {
                switch(habitTitle) {
                    case "Drink Water":
                        return getRandomMessage('habitResponses', 'personalizedDrinkWater');
                    case "Stretch":
                        return getRandomMessage('habitResponses', 'personalizedStretch');
                    case "Read":
                        return getRandomMessage('habitResponses', 'personalizedRead');
                    default:
                        return getRandomMessage('habitResponses', 'personalizedDefault');
                }
            } else {
                // Fall back to regular responses
                if (jerryDialogues.habitResponses[habitTitle]) {
                    const responses = jerryDialogues.habitResponses[habitTitle];
                    return responses[Math.floor(Math.random() * responses.length)];
                } else {
                    return getRandomMessage('habitResponses', 'default');
                }
            }
        }

        // Get random motivational phrase with anti-repetition logic and personalization
        function getRandomMotivationalPhrase() {
            const userName = gameState.userName;
            const motivationalPhrases = userName ? jerryDialogues.personalizedMotivation : jerryDialogues.motivation;
            
            if (!motivationalPhrases || motivationalPhrases.length === 0) return "Keep going!";
            
            // Initialize last motivational phrase index if not exists
            if (!gameState.lastMotivationalPhraseIndex) {
                gameState.lastMotivationalPhraseIndex = -1;
            }
            
            let newIndex;
            // Ensure we don't repeat the same phrase back-to-back
            do {
                newIndex = Math.floor(Math.random() * motivationalPhrases.length);
            } while (newIndex === gameState.lastMotivationalPhraseIndex && motivationalPhrases.length > 1);
            
            gameState.lastMotivationalPhraseIndex = newIndex;
            saveGameState();
            
            const selectedPhrase = motivationalPhrases[newIndex];
            
            // Replace {name} placeholder with actual user name
            if (userName && selectedPhrase.includes('{name}')) {
                return selectedPhrase.replace(/{name}/g, userName);
            }
            
            return selectedPhrase;
        }

        // Get health mood message based on specific thresholds
        function getHealthMoodMessage() {
            const health = gameState.health;
            let moodCategory = '';
            
            if (health >= 80) {
                moodCategory = 'confident';
            } else if (health >= 60) {
                moodCategory = 'slightlyWary';
            } else if (health >= 40) {
                moodCategory = 'cautious';
            } else if (health >= 30) {
                moodCategory = 'anxious';
            } else if (health >= 20) {
                moodCategory = 'low';
            } else if (health >= 10) {
                moodCategory = 'weak';
            } else {
                moodCategory = 'desperate';
            }
            
            return getRandomMessage("healthMood", moodCategory);
        }

        // Check and trigger health mood dialogue based on thresholds
        function checkHealthMoodThresholds() {
            const health = gameState.health;
            
            // Initialize health threshold tracking if not exists
            if (!gameState.healthThresholdsTriggered) {
                gameState.healthThresholdsTriggered = {};
            }
            
            // Define thresholds and check if we've crossed any
            const thresholds = [80, 60, 40, 30, 20, 10, 5];
            
            for (let threshold of thresholds) {
                // If health is at or below this threshold and we haven't triggered it yet
                if (health <= threshold && !gameState.healthThresholdsTriggered[threshold]) {
                    // Mark this threshold as triggered
                    gameState.healthThresholdsTriggered[threshold] = true;
                    
                    // Trigger the health mood dialogue
                    triggerJerryResponse('healthMood');
                    
                    // Save the game state
                    saveGameState();
                    
                    // Only trigger one threshold at a time
                    break;
                }
            }
            
            // Reset thresholds if health goes back up significantly (above 90)
            if (health > 90) {
                gameState.healthThresholdsTriggered = {};
                saveGameState();
            }
        }

        // Initialize health mood monitoring system
        function initializeHealthMoodMonitoring() {
            // Check health mood thresholds every 30 seconds
            setInterval(() => {
                checkHealthMoodThresholds();
            }, 30000);
        }

        // Initialize motivational phrase system
        function initializeMotivationalPhrases() {
            // Show motivational phrase every 2 minutes (120000 ms)
            setInterval(() => {
                triggerJerryResponse('motivation');
            }, 120000);
        }

        // Show bubble
        function showJerryDialog(message) {
            // Remove any existing dialogue bubbles
            const existingBubbles = document.querySelectorAll('.jerry-dialogue-bubble');
            existingBubbles.forEach(bubble => bubble.remove());

            const dialogueBox = document.createElement("div");
            dialogueBox.textContent = message;
            dialogueBox.className = "jerry-dialogue-bubble";
            
            // Make sure the container has relative positioning
            const container = document.querySelector('.creature-container');
            if (container) {
                container.style.position = 'relative';
                container.appendChild(dialogueBox);
                
                // Remove after 10 seconds
                setTimeout(() => {
                    if (dialogueBox.parentNode) {
                        dialogueBox.remove();
                    }
                }, 10000);
            }
        }

        // Jerry's contextual responses
        function triggerJerryResponse(context, data = null) {
            let message = "";
            
            switch (context) {
                case 'greeting':
                    message = getRandomMessage("greetings");
                    break;
                    
                case 'health':
                    if (gameState.health >= 80) {
                        message = getRandomMessage("health", "high");
                    } else if (gameState.health >= 40) {
                        message = getRandomMessage("health", "mid");
                    } else {
                        message = getRandomMessage("health", "low");
                    }
                    break;
                    
                case 'healthMood':
                    message = getHealthMoodMessage();
                    break;
                    
                case 'taskComplete':
                    message = getRandomMessage("taskCompletion");
                    break;
                    
                case 'taskCreate':
                    message = getRandomMessage("taskCreation");
                    break;
                    
                case 'levelUp':
                    message = getRandomMessage("levelUp");
                    break;
                    
                case 'hydration':
                    message = getRandomMessage("hydrationReminders");
                    break;
                    
                case 'motivation':
                    message = getRandomMotivationalPhrase();
                    break;
                    
                default:
                    return; // Don't show anything for unknown contexts
            }
            
            if (message) {
                showJerryDialog(message);
            }
        }

        // New function for item-specific dialogue
        function triggerItemEquippedDialogue(item) {
            console.log("triggerItemEquippedDialogue called with item:", item);
            let message = "";
            
            // Check if Jerry has multiple items equipped for combination responses
            if (gameState.equippedItems.length > 1) {
                message = getRandomMessage("itemEquipped", "multipleItems");
            } else {
                // Single item responses
                if (jerryDialogues.itemEquipped[item]) {
                    message = getRandomMessage("itemEquipped", item);
                } else {
                    // Fallback for items without specific dialogue
                    message = "Looking good with my new gear!";
                }
            }
            
            console.log("Showing dialogue:", message);
            showJerryDialog(message);
        }

        // Hydration reminder system
        function initializeHydrationReminders() {
            // Check for hydration reminders every minute
            setInterval(checkHydrationReminder, 60000); // Check every minute
        }

        function checkHydrationReminder() {
            if (!gameState.hydrationRemindersEnabled) {
                return;
            }

            const now = Date.now();
            const timeSinceLastReminder = now - gameState.lastHydrationReminder;

            // If it's been an hour or more since the last reminder
            if (timeSinceLastReminder >= gameState.hydrationReminderInterval) {
                triggerJerryResponse('hydration');
                gameState.lastHydrationReminder = now;
                saveGameState();
            }
        }

        // Function to toggle hydration reminders on/off
        function toggleHydrationReminders() {
            gameState.hydrationRemindersEnabled = !gameState.hydrationRemindersEnabled;
            saveGameState();
            
            if (gameState.hydrationRemindersEnabled) {
                showJerryDialog("💧 Hydration reminders are now ON! I'll remind you every hour to drink water!");
            } else {
                showJerryDialog("💧 Hydration reminders are now OFF. But don't forget to stay hydrated!");
            }
        }

        // Initialize Jerry dialogue system
        function initializeJerryDialogue() {
            // Show greeting when app loads
            setTimeout(() => {
                triggerJerryResponse('greeting');
            }, 1000);

            // Initialize motivational phrase system
            initializeMotivationalPhrases();

            // Initialize health mood monitoring system
            initializeHealthMoodMonitoring();

            // Initialize notification system
            initializeNotificationSystem();

            // Set up idle messages (every 2-3 minutes of inactivity)
            let idleTimer;
            function resetIdleTimer() {
                clearTimeout(idleTimer);
                idleTimer = setTimeout(() => {
                    triggerJerryResponse('idle');
                    resetIdleTimer(); // Set up next idle message
                }, Math.random() * 60000 + 120000); // 2-3 minutes
            }

            // Reset idle timer on user interaction
            ['click', 'scroll', 'keypress', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetIdleTimer);
            });

            resetIdleTimer();

            // Health-based messages
            setInterval(() => {
                if (gameState.health < 60 && Math.random() < 0.3) {
                    triggerJerryResponse('health');
                }
            }, 300000); // Check every 5 minutes
        }

        // Detect if app is running as PWA
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        // Initialize PWA features
        if (isPWA()) {
            console.log('Task Rock: Running as PWA');
            document.body.classList.add('pwa-mode');
        }
    </script>
</body>
</html>
